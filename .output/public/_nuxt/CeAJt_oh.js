import{d as oe,l as G,B as Z,c as m,b as r,v as M,e as d,F as ie,i as ce,a as p,n as X,t as x,r as b,o as We,C as ve,s as V,D as le,j as ue,E as te,f as he,T as _t,w as wt,x as Be,y as Ae,G as De,H as Me,z as me,_ as bt,k as ke,I as rt,g as Ge,m as Ze,p as xt}from"./CX4WDIMJ.js";import{f as kt}from"./cL3ZD5Hb.js";import{t as ye}from"./CiM0_A9B.js";import{f as Ce}from"./BALXvQ8s.js";import{s as Ct,u as we}from"./xJo2gTVb.js";import{p as Le,i as $t}from"./H1WKJ1ey.js";import"./DDxt_u6O.js";const Et={class:"h-full flex flex-col"},Tt={class:"p-4 border-b"},St={class:"flex-1 overflow-y-auto"},Rt={key:0,class:"p-4 text-center text-gray-500"},Bt={key:1,class:"p-4 text-center text-gray-500"},At={key:2,class:"divide-y"},Mt=["onClick"],Ot={class:"flex items-start space-x-3"},It={class:"flex-shrink-0"},Lt={class:"w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden"},Nt=["src","alt"],Pt={key:1,class:"text-gray-500 text-lg font-semibold"},jt={class:"flex-1 min-w-0"},Dt={class:"flex items-center justify-between mb-1"},Ut={class:"font-semibold text-gray-900 truncate"},qt={key:0,class:"ml-2 flex-shrink-0 bg-green-600 text-white text-xs font-semibold rounded-full px-2 py-1 min-w-[20px] text-center"},zt={class:"text-sm text-gray-600 truncate"},Ft={key:0,class:"text-xs text-gray-400 mt-1"},Vt=oe({__name:"ChatRoomList",props:{rooms:{},activeRoom:{},loading:{type:Boolean,default:!1}},emits:["select-room","create-room"],setup(s,{emit:e}){const{user:t,hasAnyRole:o}=G(),n=Z(()=>o(["student","parent"])),a=c=>t.value?c.student_id===t.value.id?c.tutor:c.student:null,l=c=>{if(!c)return"";try{return kt(new Date(c),{addSuffix:!0,locale:ye})}catch{return c}};return(c,u)=>(p(),m("div",Et,[r("div",Tt,[u[2]||(u[2]=r("div",{class:"flex items-center justify-between mb-2"},[r("h2",{class:"text-lg font-semibold"},"แชท")],-1)),d(n)?(p(),m("button",{key:0,onClick:u[0]||(u[0]=y=>c.$emit("create-room")),class:"w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center justify-center space-x-2"},[...u[1]||(u[1]=[r("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),r("span",null,"เริ่มแชทใหม่",-1)])])):M("",!0)]),r("div",St,[s.loading?(p(),m("div",Rt," กำลังโหลด... ")):s.rooms.length===0?(p(),m("div",Bt," ไม่มีห้องแชท ")):(p(),m("div",At,[(p(!0),m(ie,null,ce(s.rooms,y=>(p(),m("button",{key:y.id,onClick:_=>c.$emit("select-room",y),class:X(["w-full p-4 text-left hover:bg-gray-50 transition-colors",s.activeRoom?.id===y.id?"bg-green-50 border-l-4 border-l-green-600":""])},[r("div",Ot,[r("div",It,[r("div",Lt,[a(y)?.avatar_url?(p(),m("img",{key:0,src:a(y)?.avatar_url,alt:a(y)?.first_name,class:"w-full h-full object-cover"},null,8,Nt)):(p(),m("span",Pt,x(a(y)?.first_name?.charAt(0)),1))])]),r("div",jt,[r("div",Dt,[r("h3",Ut,x(a(y)?.first_name)+" "+x(a(y)?.last_name),1),y.unread_count&&y.unread_count>0?(p(),m("span",qt,x(y.unread_count>99?"99+":y.unread_count),1)):M("",!0)]),r("p",zt,x(y.course?.title),1),y.last_message_at?(p(),m("p",Ft,x(l(y.last_message_at)),1)):M("",!0)])])],10,Mt))),128))]))])]))}}),Ht=Object.assign(Vt,{__name:"ChatRoomList"}),Wt={key:0,class:"flex-shrink-0"},Kt={class:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden"},Yt=["src","alt"],Jt={key:1,class:"text-gray-500 text-sm font-semibold"},Xt={key:0,class:"text-xs text-gray-500 mb-1 px-1"},Qt={class:"flex items-center space-x-2"},Gt={key:1,class:"whitespace-pre-wrap break-words"},Zt={key:2,class:"max-w-sm"},es=["src","alt"],ts={key:1,class:"mt-2 text-sm opacity-90"},ss={key:3,class:"flex items-center space-x-2"},os={class:"flex-1 min-w-0"},ns=["href"],rs={key:0,class:"text-xs opacity-75"},is={class:"text-xs text-gray-400 mt-1 px-1"},as=oe({__name:"ChatMessage",props:{message:{},currentUserId:{}},emits:["image-click","reply","pin","scroll-to-message"],setup(s,{emit:e}){const t=s,o=e,n=Z(()=>t.message.sender_id===t.currentUserId),a=b(!1),l=b(!1),c=()=>{o("reply",t.message),l.value=!1},u=async()=>{const f=`${window.location.origin}/chat?roomId=${t.message.room_id}&messageId=${t.message.id}`;try{await navigator.clipboard.writeText(f),console.log("Copied link:",f),l.value=!1}catch(h){console.error("Failed to copy link:",h)}},y=()=>{o("pin",t.message.id,!t.message.is_pinned),l.value=!1};We(()=>{const f=()=>{l.value&&(l.value=!1)};document.addEventListener("click",f),ve(()=>{document.removeEventListener("click",f)})});const _=f=>{try{return Ce(new Date(f),"HH:mm",{locale:ye})}catch{return f}},g=f=>{if(f===0)return"0 Bytes";const h=1024,C=["Bytes","KB","MB","GB"],I=Math.floor(Math.log(f)/Math.log(h));return Math.round(f/Math.pow(h,I)*100)/100+" "+C[I]};return(f,h)=>(p(),m("div",{class:X(["flex mb-4",d(n)?"justify-end":"justify-start"])},[r("div",{class:X(["flex space-x-2 max-w-[70%]",d(n)?"flex-row-reverse space-x-reverse":""]),onMouseenter:h[4]||(h[4]=C=>a.value=!0),onMouseleave:h[5]||(h[5]=C=>a.value=!1)},[d(n)?M("",!0):(p(),m("div",Wt,[r("div",Kt,[s.message.sender?.avatar_url?(p(),m("img",{key:0,src:s.message.sender.avatar_url,alt:s.message.sender.first_name,class:"w-full h-full object-cover"},null,8,Yt)):(p(),m("span",Jt,x(s.message.sender?.first_name?.charAt(0)),1))])])),r("div",{class:X(["flex flex-col group relative",d(n)?"items-end":"items-start"])},[d(n)?M("",!0):(p(),m("span",Xt,x(s.message.sender?.first_name)+" "+x(s.message.sender?.last_name),1)),r("div",Qt,[r("div",{class:X(["rounded-lg px-4 py-2 relative",d(n)?"bg-green-600 text-white":"bg-gray-100 text-gray-900"])},[s.message.reply_to?(p(),m("div",{key:0,onClick:h[0]||(h[0]=C=>f.$emit("scroll-to-message",s.message.reply_to_id)),class:X(["mb-2 pb-2 border-l-4 pl-2 cursor-pointer hover:opacity-90 transition-opacity",d(n)?"border-white text-white bg-white bg-opacity-20 rounded":"border-gray-500 text-gray-700 bg-gray-50 rounded"])},[r("div",{class:X(["font-semibold mb-0.5",d(n)?"text-white":"text-gray-800"])},x(s.message.reply_to.sender?.first_name)+" "+x(s.message.reply_to.sender?.last_name),3),r("div",{class:X(["truncate",d(n)?"text-white":"text-gray-700"])},x(s.message.reply_to.content||s.message.reply_to.file_name||"ไฟล์"),3)],2)):M("",!0),s.message.message_type==="text"?(p(),m("p",Gt,x(s.message.content),1)):s.message.message_type==="image"?(p(),m("div",Zt,[s.message.file_url?(p(),m("img",{key:0,src:s.message.file_url,alt:s.message.content||"Image",class:"rounded-lg max-w-full h-auto cursor-pointer",onClick:h[1]||(h[1]=C=>f.$emit("image-click",s.message.file_url))},null,8,es)):M("",!0),s.message.content?(p(),m("p",ts,x(s.message.content),1)):M("",!0)])):s.message.message_type==="file"?(p(),m("div",ss,[h[6]||(h[6]=r("svg",{class:"w-5 h-5 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1)),r("div",os,[r("a",{href:s.message.file_url,target:"_blank",rel:"noopener noreferrer",class:"text-sm font-medium hover:underline truncate block"},x(s.message.file_name||"ไฟล์"),9,ns),s.message.file_size?(p(),m("p",rs,x(g(s.message.file_size)),1)):M("",!0)])])):M("",!0)],2),d(a)?(p(),m("button",{key:0,onClick:h[2]||(h[2]=V(C=>l.value=!d(l),["stop"])),class:"p-1 text-gray-400 hover:text-gray-600 transition-colors flex-shrink-0",type:"button"},[...h[7]||(h[7]=[r("svg",{class:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24"},[r("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})],-1)])])):M("",!0)]),d(l)?(p(),m("div",{key:1,class:X(["absolute z-50 bg-white border border-gray-200 rounded-lg shadow-lg py-1 min-w-[150px]",d(n)?"right-0":"left-0"]),style:{top:"100%","margin-top":"4px"},onClick:h[3]||(h[3]=V(()=>{},["stop"]))},[r("button",{onClick:c,class:"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"}," ตอบกลับ "),r("button",{onClick:u,class:"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"}," คัดลอกลิงก์ "),r("button",{onClick:y,class:"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"},x(s.message.is_pinned?"ยกเลิกปักหมุด":"ปักหมุด"),1)],2)):M("",!0),r("span",is,x(_(s.message.created_at)),1)],2)],34)],2))}}),ls=Object.assign(as,{__name:"ChatMessage"}),se=Object.create(null);se.open="0";se.close="1";se.ping="2";se.pong="3";se.message="4";se.upgrade="5";se.noop="6";const $e=Object.create(null);Object.keys(se).forEach(s=>{$e[se[s]]=s});const Ue={type:"error",data:"parser error"},it=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",at=typeof ArrayBuffer=="function",lt=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s&&s.buffer instanceof ArrayBuffer,Ke=({type:s,data:e},t,o)=>it&&e instanceof Blob?t?o(e):et(e,o):at&&(e instanceof ArrayBuffer||lt(e))?t?o(e):et(new Blob([e]),o):o(se[s]+(e||"")),et=(s,e)=>{const t=new FileReader;return t.onload=function(){const o=t.result.split(",")[1];e("b"+(o||""))},t.readAsDataURL(s)};function tt(s){return s instanceof Uint8Array?s:s instanceof ArrayBuffer?new Uint8Array(s):new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}let Ne;function cs(s,e){if(it&&s.data instanceof Blob)return s.data.arrayBuffer().then(tt).then(e);if(at&&(s.data instanceof ArrayBuffer||lt(s.data)))return e(tt(s.data));Ke(s,!1,t=>{Ne||(Ne=new TextEncoder),e(Ne.encode(t))})}const st="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ge=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let s=0;s<st.length;s++)ge[st.charCodeAt(s)]=s;const us=s=>{let e=s.length*.75,t=s.length,o,n=0,a,l,c,u;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);const y=new ArrayBuffer(e),_=new Uint8Array(y);for(o=0;o<t;o+=4)a=ge[s.charCodeAt(o)],l=ge[s.charCodeAt(o+1)],c=ge[s.charCodeAt(o+2)],u=ge[s.charCodeAt(o+3)],_[n++]=a<<2|l>>4,_[n++]=(l&15)<<4|c>>2,_[n++]=(c&3)<<6|u&63;return y},ds=typeof ArrayBuffer=="function",Ye=(s,e)=>{if(typeof s!="string")return{type:"message",data:ct(s,e)};const t=s.charAt(0);return t==="b"?{type:"message",data:hs(s.substring(1),e)}:$e[t]?s.length>1?{type:$e[t],data:s.substring(1)}:{type:$e[t]}:Ue},hs=(s,e)=>{if(ds){const t=us(s);return ct(t,e)}else return{base64:!0,data:s}},ct=(s,e)=>e==="blob"?s instanceof Blob?s:new Blob([s]):s instanceof ArrayBuffer?s:s.buffer,ut="",fs=(s,e)=>{const t=s.length,o=new Array(t);let n=0;s.forEach((a,l)=>{Ke(a,!1,c=>{o[l]=c,++n===t&&e(o.join(ut))})})},ps=(s,e)=>{const t=s.split(ut),o=[];for(let n=0;n<t.length;n++){const a=Ye(t[n],e);if(o.push(a),a.type==="error")break}return o};function ms(){return new TransformStream({transform(s,e){cs(s,t=>{const o=t.length;let n;if(o<126)n=new Uint8Array(1),new DataView(n.buffer).setUint8(0,o);else if(o<65536){n=new Uint8Array(3);const a=new DataView(n.buffer);a.setUint8(0,126),a.setUint16(1,o)}else{n=new Uint8Array(9);const a=new DataView(n.buffer);a.setUint8(0,127),a.setBigUint64(1,BigInt(o))}s.data&&typeof s.data!="string"&&(n[0]|=128),e.enqueue(n),e.enqueue(t)})}})}let Pe;function be(s){return s.reduce((e,t)=>e+t.length,0)}function xe(s,e){if(s[0].length===e)return s.shift();const t=new Uint8Array(e);let o=0;for(let n=0;n<e;n++)t[n]=s[0][o++],o===s[0].length&&(s.shift(),o=0);return s.length&&o<s[0].length&&(s[0]=s[0].slice(o)),t}function gs(s,e){Pe||(Pe=new TextDecoder);const t=[];let o=0,n=-1,a=!1;return new TransformStream({transform(l,c){for(t.push(l);;){if(o===0){if(be(t)<1)break;const u=xe(t,1);a=(u[0]&128)===128,n=u[0]&127,n<126?o=3:n===126?o=1:o=2}else if(o===1){if(be(t)<2)break;const u=xe(t,2);n=new DataView(u.buffer,u.byteOffset,u.length).getUint16(0),o=3}else if(o===2){if(be(t)<8)break;const u=xe(t,8),y=new DataView(u.buffer,u.byteOffset,u.length),_=y.getUint32(0);if(_>Math.pow(2,21)-1){c.enqueue(Ue);break}n=_*Math.pow(2,32)+y.getUint32(4),o=3}else{if(be(t)<n)break;const u=xe(t,n);c.enqueue(Ye(a?u:Pe.decode(u),e)),o=0}if(n===0||n>s){c.enqueue(Ue);break}}}})}const dt=4;function P(s){if(s)return ys(s)}function ys(s){for(var e in P.prototype)s[e]=P.prototype[e];return s}P.prototype.on=P.prototype.addEventListener=function(s,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+s]=this._callbacks["$"+s]||[]).push(e),this};P.prototype.once=function(s,e){function t(){this.off(s,t),e.apply(this,arguments)}return t.fn=e,this.on(s,t),this};P.prototype.off=P.prototype.removeListener=P.prototype.removeAllListeners=P.prototype.removeEventListener=function(s,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+s];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+s],this;for(var o,n=0;n<t.length;n++)if(o=t[n],o===e||o.fn===e){t.splice(n,1);break}return t.length===0&&delete this._callbacks["$"+s],this};P.prototype.emit=function(s){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+s],o=1;o<arguments.length;o++)e[o-1]=arguments[o];if(t){t=t.slice(0);for(var o=0,n=t.length;o<n;++o)t[o].apply(this,e)}return this};P.prototype.emitReserved=P.prototype.emit;P.prototype.listeners=function(s){return this._callbacks=this._callbacks||{},this._callbacks["$"+s]||[]};P.prototype.hasListeners=function(s){return!!this.listeners(s).length};const Oe=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),K=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),vs="arraybuffer";function ht(s,...e){return e.reduce((t,o)=>(s.hasOwnProperty(o)&&(t[o]=s[o]),t),{})}const _s=K.setTimeout,ws=K.clearTimeout;function Ie(s,e){e.useNativeTimers?(s.setTimeoutFn=_s.bind(K),s.clearTimeoutFn=ws.bind(K)):(s.setTimeoutFn=K.setTimeout.bind(K),s.clearTimeoutFn=K.clearTimeout.bind(K))}const bs=1.33;function xs(s){return typeof s=="string"?ks(s):Math.ceil((s.byteLength||s.size)*bs)}function ks(s){let e=0,t=0;for(let o=0,n=s.length;o<n;o++)e=s.charCodeAt(o),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(o++,t+=4);return t}function ft(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Cs(s){let e="";for(let t in s)s.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(s[t]));return e}function $s(s){let e={},t=s.split("&");for(let o=0,n=t.length;o<n;o++){let a=t[o].split("=");e[decodeURIComponent(a[0])]=decodeURIComponent(a[1])}return e}class Es extends Error{constructor(e,t,o){super(e),this.description=t,this.context=o,this.type="TransportError"}}class Je extends P{constructor(e){super(),this.writable=!1,Ie(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,o){return super.emitReserved("error",new Es(e,t,o)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=Ye(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=Cs(e);return t.length?"?"+t:""}}class Ts extends Je{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let o=0;this._polling&&(o++,this.once("pollComplete",function(){--o||t()})),this.writable||(o++,this.once("drain",function(){--o||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=o=>{if(this.readyState==="opening"&&o.type==="open"&&this.onOpen(),o.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(o)};ps(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,fs(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=ft()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let pt=!1;try{pt=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Ss=pt;function Rs(){}class Bs extends Ts{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let o=location.port;o||(o=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||o!==e.port}}doWrite(e,t){const o=this.request({method:"POST",data:e});o.on("success",t),o.on("error",(n,a)=>{this.onError("xhr post error",n,a)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,o)=>{this.onError("xhr poll error",t,o)}),this.pollXhr=e}}class ee extends P{constructor(e,t,o){super(),this.createRequest=e,Ie(this,o),this._opts=o,this._method=o.method||"GET",this._uri=t,this._data=o.data!==void 0?o.data:null,this._create()}_create(){var e;const t=ht(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const o=this._xhr=this.createRequest(t);try{o.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){o.setDisableHeaderCheck&&o.setDisableHeaderCheck(!0);for(let n in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(n)&&o.setRequestHeader(n,this._opts.extraHeaders[n])}}catch{}if(this._method==="POST")try{o.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{o.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(o),"withCredentials"in o&&(o.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(o.timeout=this._opts.requestTimeout),o.onreadystatechange=()=>{var n;o.readyState===3&&((n=this._opts.cookieJar)===null||n===void 0||n.parseCookies(o.getResponseHeader("set-cookie"))),o.readyState===4&&(o.status===200||o.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof o.status=="number"?o.status:0)},0))},o.send(this._data)}catch(n){this.setTimeoutFn(()=>{this._onError(n)},0);return}typeof document<"u"&&(this._index=ee.requestsCount++,ee.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Rs,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete ee.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}ee.requestsCount=0;ee.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",ot);else if(typeof addEventListener=="function"){const s="onpagehide"in K?"pagehide":"unload";addEventListener(s,ot,!1)}}function ot(){for(let s in ee.requests)ee.requests.hasOwnProperty(s)&&ee.requests[s].abort()}const As=(function(){const s=mt({xdomain:!1});return s&&s.responseType!==null})();class Ms extends Bs{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=As&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new ee(mt,this.uri(),e)}}function mt(s){const e=s.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||Ss))return new XMLHttpRequest}catch{}if(!e)try{return new K[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const gt=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Os extends Je{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,o=gt?{}:ht(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(o.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,o)}catch(n){return this.emitReserved("error",n)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const o=e[t],n=t===e.length-1;Ke(o,this.supportsBinary,a=>{try{this.doWrite(o,a)}catch{}n&&Oe(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=ft()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const je=K.WebSocket||K.MozWebSocket;class Is extends Os{createSocket(e,t,o){return gt?new je(e,t,o):t?new je(e,t):new je(e)}doWrite(e,t){this.ws.send(t)}}class Ls extends Je{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=gs(Number.MAX_SAFE_INTEGER,this.socket.binaryType),o=e.readable.pipeThrough(t).getReader(),n=ms();n.readable.pipeTo(e.writable),this._writer=n.writable.getWriter();const a=()=>{o.read().then(({done:c,value:u})=>{c||(this.onPacket(u),a())}).catch(c=>{})};a();const l={type:"open"};this.query.sid&&(l.data=`{"sid":"${this.query.sid}"}`),this._writer.write(l).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const o=e[t],n=t===e.length-1;this._writer.write(o).then(()=>{n&&Oe(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const Ns={websocket:Is,webtransport:Ls,polling:Ms},Ps=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,js=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function qe(s){if(s.length>8e3)throw"URI too long";const e=s,t=s.indexOf("["),o=s.indexOf("]");t!=-1&&o!=-1&&(s=s.substring(0,t)+s.substring(t,o).replace(/:/g,";")+s.substring(o,s.length));let n=Ps.exec(s||""),a={},l=14;for(;l--;)a[js[l]]=n[l]||"";return t!=-1&&o!=-1&&(a.source=e,a.host=a.host.substring(1,a.host.length-1).replace(/;/g,":"),a.authority=a.authority.replace("[","").replace("]","").replace(/;/g,":"),a.ipv6uri=!0),a.pathNames=Ds(a,a.path),a.queryKey=Us(a,a.query),a}function Ds(s,e){const t=/\/{2,9}/g,o=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&o.splice(0,1),e.slice(-1)=="/"&&o.splice(o.length-1,1),o}function Us(s,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(o,n,a){n&&(t[n]=a)}),t}const ze=typeof addEventListener=="function"&&typeof removeEventListener=="function",Ee=[];ze&&addEventListener("offline",()=>{Ee.forEach(s=>s())},!1);class re extends P{constructor(e,t){if(super(),this.binaryType=vs,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const o=qe(e);t.hostname=o.host,t.secure=o.protocol==="https"||o.protocol==="wss",t.port=o.port,o.query&&(t.query=o.query)}else t.host&&(t.hostname=qe(t.host).host);Ie(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(o=>{const n=o.prototype.name;this.transports.push(n),this._transportsByName[n]=o}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=$s(this.opts.query)),ze&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},Ee.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=dt,t.transport=e,this.id&&(t.sid=this.id);const o=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](o)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&re.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",re.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let o=0;o<this.writeBuffer.length;o++){const n=this.writeBuffer[o].data;if(n&&(t+=xs(n)),o>0&&t>this._maxPayload)return this.writeBuffer.slice(0,o);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,Oe(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,o){return this._sendPacket("message",e,t,o),this}send(e,t,o){return this._sendPacket("message",e,t,o),this}_sendPacket(e,t,o,n){if(typeof t=="function"&&(n=t,t=void 0),typeof o=="function"&&(n=o,o=null),this.readyState==="closing"||this.readyState==="closed")return;o=o||{},o.compress=o.compress!==!1;const a={type:e,data:t,options:o};this.emitReserved("packetCreate",a),this.writeBuffer.push(a),n&&this.once("flush",n),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},o=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?o():e()}):this.upgrading?o():e()),this}_onError(e){if(re.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),ze&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const o=Ee.indexOf(this._offlineEventListener);o!==-1&&Ee.splice(o,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}re.protocol=dt;class qs extends re{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),o=!1;re.priorWebsocketSuccess=!1;const n=()=>{o||(t.send([{type:"ping",data:"probe"}]),t.once("packet",g=>{if(!o)if(g.type==="pong"&&g.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;re.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{o||this.readyState!=="closed"&&(_(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const f=new Error("probe error");f.transport=t.name,this.emitReserved("upgradeError",f)}}))};function a(){o||(o=!0,_(),t.close(),t=null)}const l=g=>{const f=new Error("probe error: "+g);f.transport=t.name,a(),this.emitReserved("upgradeError",f)};function c(){l("transport closed")}function u(){l("socket closed")}function y(g){t&&g.name!==t.name&&a()}const _=()=>{t.removeListener("open",n),t.removeListener("error",l),t.removeListener("close",c),this.off("close",u),this.off("upgrading",y)};t.once("open",n),t.once("error",l),t.once("close",c),this.once("close",u),this.once("upgrading",y),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{o||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let o=0;o<e.length;o++)~this.transports.indexOf(e[o])&&t.push(e[o]);return t}}let zs=class extends qs{constructor(e,t={}){const o=typeof e=="object"?e:t;(!o.transports||o.transports&&typeof o.transports[0]=="string")&&(o.transports=(o.transports||["polling","websocket","webtransport"]).map(n=>Ns[n]).filter(n=>!!n)),super(e,o)}};function Fs(s,e="",t){let o=s;t=t||typeof location<"u"&&location,s==null&&(s=t.protocol+"//"+t.host),typeof s=="string"&&(s.charAt(0)==="/"&&(s.charAt(1)==="/"?s=t.protocol+s:s=t.host+s),/^(https?|wss?):\/\//.test(s)||(typeof t<"u"?s=t.protocol+"//"+s:s="https://"+s),o=qe(s)),o.port||(/^(http|ws)$/.test(o.protocol)?o.port="80":/^(http|ws)s$/.test(o.protocol)&&(o.port="443")),o.path=o.path||"/";const a=o.host.indexOf(":")!==-1?"["+o.host+"]":o.host;return o.id=o.protocol+"://"+a+":"+o.port+e,o.href=o.protocol+"://"+a+(t&&t.port===o.port?"":":"+o.port),o}const Vs=typeof ArrayBuffer=="function",Hs=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s.buffer instanceof ArrayBuffer,yt=Object.prototype.toString,Ws=typeof Blob=="function"||typeof Blob<"u"&&yt.call(Blob)==="[object BlobConstructor]",Ks=typeof File=="function"||typeof File<"u"&&yt.call(File)==="[object FileConstructor]";function Xe(s){return Vs&&(s instanceof ArrayBuffer||Hs(s))||Ws&&s instanceof Blob||Ks&&s instanceof File}function Te(s,e){if(!s||typeof s!="object")return!1;if(Array.isArray(s)){for(let t=0,o=s.length;t<o;t++)if(Te(s[t]))return!0;return!1}if(Xe(s))return!0;if(s.toJSON&&typeof s.toJSON=="function"&&arguments.length===1)return Te(s.toJSON(),!0);for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)&&Te(s[t]))return!0;return!1}function Ys(s){const e=[],t=s.data,o=s;return o.data=Fe(t,e),o.attachments=e.length,{packet:o,buffers:e}}function Fe(s,e){if(!s)return s;if(Xe(s)){const t={_placeholder:!0,num:e.length};return e.push(s),t}else if(Array.isArray(s)){const t=new Array(s.length);for(let o=0;o<s.length;o++)t[o]=Fe(s[o],e);return t}else if(typeof s=="object"&&!(s instanceof Date)){const t={};for(const o in s)Object.prototype.hasOwnProperty.call(s,o)&&(t[o]=Fe(s[o],e));return t}return s}function Js(s,e){return s.data=Ve(s.data,e),delete s.attachments,s}function Ve(s,e){if(!s)return s;if(s&&s._placeholder===!0){if(typeof s.num=="number"&&s.num>=0&&s.num<e.length)return e[s.num];throw new Error("illegal attachments")}else if(Array.isArray(s))for(let t=0;t<s.length;t++)s[t]=Ve(s[t],e);else if(typeof s=="object")for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&(s[t]=Ve(s[t],e));return s}const Xs=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],Qs=5;var S;(function(s){s[s.CONNECT=0]="CONNECT",s[s.DISCONNECT=1]="DISCONNECT",s[s.EVENT=2]="EVENT",s[s.ACK=3]="ACK",s[s.CONNECT_ERROR=4]="CONNECT_ERROR",s[s.BINARY_EVENT=5]="BINARY_EVENT",s[s.BINARY_ACK=6]="BINARY_ACK"})(S||(S={}));class Gs{constructor(e){this.replacer=e}encode(e){return(e.type===S.EVENT||e.type===S.ACK)&&Te(e)?this.encodeAsBinary({type:e.type===S.EVENT?S.BINARY_EVENT:S.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===S.BINARY_EVENT||e.type===S.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Ys(e),o=this.encodeAsString(t.packet),n=t.buffers;return n.unshift(o),n}}function nt(s){return Object.prototype.toString.call(s)==="[object Object]"}class Qe extends P{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const o=t.type===S.BINARY_EVENT;o||t.type===S.BINARY_ACK?(t.type=o?S.EVENT:S.ACK,this.reconstructor=new Zs(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(Xe(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const o={type:Number(e.charAt(0))};if(S[o.type]===void 0)throw new Error("unknown packet type "+o.type);if(o.type===S.BINARY_EVENT||o.type===S.BINARY_ACK){const a=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const l=e.substring(a,t);if(l!=Number(l)||e.charAt(t)!=="-")throw new Error("Illegal attachments");o.attachments=Number(l)}if(e.charAt(t+1)==="/"){const a=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););o.nsp=e.substring(a,t)}else o.nsp="/";const n=e.charAt(t+1);if(n!==""&&Number(n)==n){const a=t+1;for(;++t;){const l=e.charAt(t);if(l==null||Number(l)!=l){--t;break}if(t===e.length)break}o.id=Number(e.substring(a,t+1))}if(e.charAt(++t)){const a=this.tryParse(e.substr(t));if(Qe.isPayloadValid(o.type,a))o.data=a;else throw new Error("invalid payload")}return o}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case S.CONNECT:return nt(t);case S.DISCONNECT:return t===void 0;case S.CONNECT_ERROR:return typeof t=="string"||nt(t);case S.EVENT:case S.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&Xs.indexOf(t[0])===-1);case S.ACK:case S.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Zs{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=Js(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const eo=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Qe,Encoder:Gs,get PacketType(){return S},protocol:Qs},Symbol.toStringTag,{value:"Module"}));function Q(s,e,t){return s.on(e,t),function(){s.off(e,t)}}const to=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class vt extends P{constructor(e,t,o){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,o&&o.auth&&(this.auth=o.auth),this._opts=Object.assign({},o),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Q(e,"open",this.onopen.bind(this)),Q(e,"packet",this.onpacket.bind(this)),Q(e,"error",this.onerror.bind(this)),Q(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var o,n,a;if(to.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const l={type:S.EVENT,data:t};if(l.options={},l.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const _=this.ids++,g=t.pop();this._registerAckCallback(_,g),l.id=_}const c=(n=(o=this.io.engine)===null||o===void 0?void 0:o.transport)===null||n===void 0?void 0:n.writable,u=this.connected&&!(!((a=this.io.engine)===null||a===void 0)&&a._hasPingExpired());return this.flags.volatile&&!c||(u?(this.notifyOutgoingListeners(l),this.packet(l)):this.sendBuffer.push(l)),this.flags={},this}_registerAckCallback(e,t){var o;const n=(o=this.flags.timeout)!==null&&o!==void 0?o:this._opts.ackTimeout;if(n===void 0){this.acks[e]=t;return}const a=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let c=0;c<this.sendBuffer.length;c++)this.sendBuffer[c].id===e&&this.sendBuffer.splice(c,1);t.call(this,new Error("operation has timed out"))},n),l=(...c)=>{this.io.clearTimeoutFn(a),t.apply(this,c)};l.withError=!0,this.acks[e]=l}emitWithAck(e,...t){return new Promise((o,n)=>{const a=(l,c)=>l?n(l):o(c);a.withError=!0,t.push(a),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const o={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((n,...a)=>o!==this._queue[0]?void 0:(n!==null?o.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(n)):(this._queue.shift(),t&&t(null,...a)),o.pending=!1,this._drainQueue())),this._queue.push(o),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:S.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(o=>String(o.id)===e)){const o=this.acks[e];delete this.acks[e],o.withError&&o.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case S.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case S.EVENT:case S.BINARY_EVENT:this.onevent(e);break;case S.ACK:case S.BINARY_ACK:this.onack(e);break;case S.DISCONNECT:this.ondisconnect();break;case S.CONNECT_ERROR:this.destroy();const o=new Error(e.data.message);o.data=e.data.data,this.emitReserved("connect_error",o);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const o of t)o.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let o=!1;return function(...n){o||(o=!0,t.packet({type:S.ACK,id:e,data:n}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:S.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let o=0;o<t.length;o++)if(e===t[o])return t.splice(o,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let o=0;o<t.length;o++)if(e===t[o])return t.splice(o,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const o of t)o.apply(this,e.data)}}}function fe(s){s=s||{},this.ms=s.min||100,this.max=s.max||1e4,this.factor=s.factor||2,this.jitter=s.jitter>0&&s.jitter<=1?s.jitter:0,this.attempts=0}fe.prototype.duration=function(){var s=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*s);s=(Math.floor(e*10)&1)==0?s-t:s+t}return Math.min(s,this.max)|0};fe.prototype.reset=function(){this.attempts=0};fe.prototype.setMin=function(s){this.ms=s};fe.prototype.setMax=function(s){this.max=s};fe.prototype.setJitter=function(s){this.jitter=s};class He extends P{constructor(e,t){var o;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,Ie(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((o=t.randomizationFactor)!==null&&o!==void 0?o:.5),this.backoff=new fe({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const n=t.parser||eo;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new zs(this.uri,this.opts);const t=this.engine,o=this;this._readyState="opening",this.skipReconnect=!1;const n=Q(t,"open",function(){o.onopen(),e&&e()}),a=c=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",c),e?e(c):this.maybeReconnectOnOpen()},l=Q(t,"error",a);if(this._timeout!==!1){const c=this._timeout,u=this.setTimeoutFn(()=>{n(),a(new Error("timeout")),t.close()},c);this.opts.autoUnref&&u.unref(),this.subs.push(()=>{this.clearTimeoutFn(u)})}return this.subs.push(n),this.subs.push(l),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Q(e,"ping",this.onping.bind(this)),Q(e,"data",this.ondata.bind(this)),Q(e,"error",this.onerror.bind(this)),Q(e,"close",this.onclose.bind(this)),Q(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){Oe(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let o=this.nsps[e];return o?this._autoConnect&&!o.active&&o.connect():(o=new vt(this,e,t),this.nsps[e]=o),o}_destroy(e){const t=Object.keys(this.nsps);for(const o of t)if(this.nsps[o].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let o=0;o<t.length;o++)this.engine.write(t[o],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var o;this.cleanup(),(o=this.engine)===null||o===void 0||o.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const o=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(n=>{n?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",n)):e.onreconnect()}))},t);this.opts.autoUnref&&o.unref(),this.subs.push(()=>{this.clearTimeoutFn(o)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const pe={};function Se(s,e){typeof s=="object"&&(e=s,s=void 0),e=e||{};const t=Fs(s,e.path||"/socket.io"),o=t.source,n=t.id,a=t.path,l=pe[n]&&a in pe[n].nsps,c=e.forceNew||e["force new connection"]||e.multiplex===!1||l;let u;return c?u=new He(o,e):(pe[n]||(pe[n]=new He(o,e)),u=pe[n]),t.query&&!e.query&&(e.query=t.queryKey),u.socket(t.path,e)}Object.assign(Se,{Manager:He,Socket:vt,io:Se,connect:Se});const so=()=>{const s=ue(),{accessToken:e}=G(),t=b(null),o=b(!1),n=()=>{if(typeof window>"u"){console.warn("[Chat Socket] Cannot connect in server-side");return}if(t.value?.connected){console.log("[Chat Socket] Already connected");return}if(!e.value){console.warn("[Chat Socket] No access token, cannot connect");return}const g=s.public.apiBase.replace("/api","")||window.location.origin,f=g.startsWith("http")?g:`${window.location.protocol}//${window.location.host}${g}`;console.log("[Chat Socket] 🔌 Connecting to:",f.replace(e.value,"***"));try{t.value=Se(f,{auth:{token:e.value},path:"/socket.io",transports:["websocket","polling"],reconnection:!0,reconnectionDelay:1e3,reconnectionAttempts:5})}catch(h){console.error("[Chat Socket] Failed to create socket:",h);return}t.value.on("connect",()=>{o.value=!0,console.log("[Chat Socket] ✅ Connected to server, socket ID:",t.value?.id)}),t.value.on("disconnect",()=>{o.value=!1,console.log("[Chat Socket] ⚠️  Disconnected from server")}),t.value.on("connect_error",h=>{console.error("[Chat Socket] ❌ Connection error:",h),o.value=!1}),t.value.on("error",h=>{console.error("[Chat Socket] ❌ Socket error:",h.message)})},a=()=>{t.value&&(t.value.disconnect(),t.value=null,o.value=!1,console.log("[Chat Socket] ⚠️  Disconnected"))},l=g=>{t.value&&o.value?(console.log(`[Chat Socket] 📥 Emitting join_room for room ${g}`,{socketId:t.value.id,connected:o.value}),t.value.emit("join_room",{roomId:g}),t.value.once("room_joined",f=>{console.log(`[Chat Socket] ✅ Successfully joined room ${f.roomId}`)}),t.value.once("error",f=>{console.error(`[Chat Socket] ❌ Error joining room ${g}:`,f.message)})):console.warn("[Chat Socket] ⚠️  Cannot join room: not connected",{hasSocket:!!t.value,connected:o.value,roomId:g})},c=g=>{t.value&&o.value&&(t.value.emit("leave_room",{roomId:g}),console.log(`[Chat Socket] 📤 Leaving room ${g}`))},u=(g,f)=>{t.value?(t.value.hasListeners(g)&&(console.log(`[Chat Socket] ⚠️ Event ${g} already has listeners, removing old ones first`),t.value.off(g)),t.value.on(g,f),console.log(`[Chat Socket] 👂 Listening to event: ${g}`,{socketId:t.value.id,connected:t.value.connected})):console.warn(`[Chat Socket] ⚠️ Cannot listen to ${g}: socket not available`)},y=(g,f)=>{t.value&&t.value.off(g,f)},_=(g,f)=>{t.value&&o.value?t.value.emit(g,f):console.warn(`[Chat Socket] Cannot emit ${g}: not connected`)};return{socket:le(t),connected:le(o),connect:n,disconnect:a,joinRoom:l,leaveRoom:c,on:u,off:y,emit:_}},Re=()=>{const s=ue(),{accessToken:e,user:t}=G(),o=b([]),n=b(null),a=b([]),l=b(new Map),{socket:c,connected:u,connect:y,disconnect:_,joinRoom:g,leaveRoom:f,on:h,emit:C}=so(),I=b(null);te([u,I],([i,v])=>{i&&v&&(console.log(`[Chat] ✅ Both connected and roomId ready, joining room ${v}`),g(v))},{immediate:!0});const z=async()=>{try{const i=await $fetch(`${s.public.apiBase}/chat/rooms`,{headers:{Authorization:`Bearer ${e.value}`}});if(i.success&&(o.value=i.data,u.value?i.data.forEach(v=>{g(v.id)}):i.data.length>0&&(I.value=i.data[0].id),typeof window<"u")){const{updateUnreadCount:v}=we();v(i.data)}}catch(i){console.error("[Chat] Error loading rooms:",i)}},F=async i=>{try{const v=await $fetch(`${s.public.apiBase}/chat/rooms/${i}`,{headers:{Authorization:`Bearer ${e.value}`}});if(v.success)return n.value=v.data,console.log("[Chat] 📋 Loaded room:",{roomId:v.data.id,studentId:v.data.student_id,tutorId:v.data.tutor_id}),u.value?(console.log(`[Chat] 📥 Joining room ${i} via Socket.IO`),g(i)):console.warn(`[Chat] ⚠️  Socket.IO not connected, cannot join room ${i}`),v.data}catch(v){throw console.error("[Chat] Error loading room:",v),v}},O=async(i,v=50,E=0)=>{try{const T=await $fetch(`${s.public.apiBase}/chat/rooms/${i}/messages?limit=${v}&offset=${E}`,{headers:{Authorization:`Bearer ${e.value}`}});if(T.success){if(E===0){const U=a.value.filter(q=>q.room_id!==i);a.value=[...U,...T.data],console.log("[Chat] 📋 First load messages for room:",{roomId:i,apiCount:T.data.length,otherRoomsCount:U.length,totalCount:a.value.length})}else{const U=new Set(a.value.map(D=>D.id)),q=T.data.filter(D=>!U.has(D.id));a.value=[...q,...a.value],console.log("[Chat] 📋 Loaded more messages for room:",{roomId:i,apiCount:T.data.length,newCount:q.length,totalCount:a.value.length})}return T.data}}catch(T){throw console.error("[Chat] Error loading messages:",T),T}},R=i=>{I.value=i},B=i=>{u.value&&f(i),I.value===i&&(I.value=null)},H=b(new Set),Y=async i=>{const v=i.content||"";`${i.room_id}${v}${Date.now()}`,console.log("[Chat] 🚀 sendMessage called:",{roomId:i.room_id,content:v,messageType:i.message_type,userId:t.value?.id,timestamp:new Date().toISOString()});const E=`${i.room_id}-${v}`;if(H.value.has(E)){console.log("[Chat] ⚠️ Message already being sent, skipping duplicate:",v.substring(0,50));return}H.value.add(E),console.log("[Chat] ✅ Message marked as sending, duplicateKey:",E);try{const U={id:`temp-${Date.now()}-${Math.random()}`,room_id:i.room_id,sender_id:t.value?.id||0,message_type:i.message_type||"text",content:v,file_url:i.file_url||null,file_name:i.file_name||null,file_size:i.file_size||null,file_type:i.file_type||null,is_read:!1,read_at:null,created_at:new Date().toISOString(),sender:{id:t.value?.id||0,first_name:t.value?.first_name||"",last_name:t.value?.last_name||"",avatar_url:t.value?.avatar_url||null}};a.value.some(de=>{const J=de.id;return typeof J=="string"&&J.startsWith("temp-")&&de.content===v&&de.room_id===i.room_id})||(a.value=[...a.value,U]),console.log("[Chat] 📤 Sending message via REST API:",{roomId:i.room_id,content:i.content?.substring(0,50),messageType:i.message_type,apiUrl:`${s.public.apiBase}/chat/rooms/${i.room_id}/messages`,hasToken:!!e.value});const D=await $fetch(`${s.public.apiBase}/chat/rooms/${i.room_id}/messages`,{method:"POST",headers:{Authorization:`Bearer ${e.value}`},body:{content:i.content,message_type:i.message_type||"text",file_url:i.file_url,file_name:i.file_name,file_size:i.file_size,file_type:i.file_type,reply_to_id:i.reply_to_id||null}});if(console.log("[Chat] 📥 REST API response received:",{success:D.success,messageId:D.data?.id,content:D.data?.content?.substring(0,50),roomId:D.data?.room_id}),D.success){console.log("[Chat] 📥 REST API response received:",{messageId:D.data.id,content:D.data.content?.substring(0,50)});const de=a.value.findIndex(J=>{const _e=J.id;return typeof _e=="string"&&_e.startsWith("temp-")&&J.content===v&&J.sender_id===t.value?.id&&J.room_id===i.room_id});if(de!==-1){const J=[...a.value];J[de]=D.data,a.value=J,console.log("[Chat] ✅ Replaced optimistic message with real message")}else a.value.some(_e=>_e.id===D.data.id)||(a.value=[...a.value,D.data],console.log("[Chat] ✅ Added real message from REST API"))}}catch(T){console.error("[Chat] ❌ Error sending message via REST API:",T);const U=a.value.findIndex(q=>{const D=q.id;return typeof D=="string"&&D.startsWith("temp-")&&q.content===v&&q.sender_id===t.value?.id&&q.room_id===i.room_id});if(U!==-1){const q=[...a.value];q.splice(U,1),a.value=q}throw T}finally{setTimeout(()=>{H.value.delete(E)},2e3)}},ae=async(i,v)=>{if(u.value)C("mark_read",{roomId:i,messageId:v});else try{await $fetch(`${s.public.apiBase}/chat/rooms/${i}/messages/read`,{method:"POST",headers:{Authorization:`Bearer ${e.value}`},body:{messageId:v}})}catch(T){console.error("[Chat] Error marking messages as read:",T)}const E=o.value.find(T=>T.id===i);if(E&&(E.unread_count=0,typeof window<"u")){const{updateUnreadCount:T}=we();T(o.value)}},N=async i=>{if(u.value)C("typing",{roomId:i});else try{await $fetch(`${s.public.apiBase}/chat/rooms/${i}/typing`,{method:"POST",headers:{Authorization:`Bearer ${e.value}`}})}catch(v){console.error("[Chat] Error starting typing:",v)}},k=async i=>{if(u.value)C("stop_typing",{roomId:i});else try{await $fetch(`${s.public.apiBase}/chat/rooms/${i}/typing/stop`,{method:"POST",headers:{Authorization:`Bearer ${e.value}`}})}catch(v){console.error("[Chat] Error stopping typing:",v)}},w=async(i,v,E="image")=>{const T=new FormData;T.append("file",v);const U=await $fetch(`${s.public.apiBase}/chat/upload?roomId=${i}&fileType=${E}`,{method:"POST",headers:{Authorization:`Bearer ${e.value}`},body:T});if(U.success)return U.data;throw new Error("Failed to upload file")},$=i=>a.value.filter(v=>v.room_id===i),L=Z(()=>{if(!n.value?.id)return[];const v=[...a.value.filter(E=>E.room_id===n.value.id)].sort((E,T)=>{const U=new Date(E.created_at).getTime(),q=new Date(T.created_at).getTime();return U-q});return console.log("[Chat] 🔄 sortedMessages computed:",{roomId:n.value.id,count:v.length,messageIds:v.map(E=>E.id).slice(-5)}),v}),j=i=>{const v=l.value.get(i);return v?Array.from(v):[]},W=i=>{a.value=a.value.filter(v=>v.room_id!==i)},ne=i=>{console.log("[Chat] 🎯 setActiveRoom called:",{roomId:i?.id||"null",previousRoomId:n.value?.id,connected:u.value}),n.value&&u.value&&(console.log(`[Chat] 📤 Leaving previous room ${n.value.id}`),f(n.value.id)),n.value=i,n.value?I.value=n.value.id:I.value=null},A=()=>{if(typeof window>"u"){console.warn("[Chat] Cannot setup event listeners in server-side");return}if(!c.value){console.warn("[Chat] ⚠️ Socket not available, cannot setup event listeners"),console.warn("[Chat] ⚠️ Will retry when socket is available...");const i=Ct(()=>{c.value&&(console.log("[Chat] ✅ Socket available now, setting up event listeners..."),clearInterval(i),A())},500);setTimeout(()=>clearInterval(i),1e4);return}console.log("[Chat] ✅ Setting up Socket.IO event listeners, socket ID:",c.value.id),h("new_message",i=>{if(console.log("[Chat] 📨 Socket.IO event: new_message received:",{id:i.id,roomId:i.room_id,senderId:i.sender_id,currentUserId:t.value?.id,content:i.content?.substring(0,50)}),i.sender_id===t.value?.id){console.log("[Chat] ⏭️  Skipping own message from Socket.IO");return}a.value.some(T=>T.id===i.id)?console.log("[Chat] ⚠️ Message ID",i.id,"already exists - skipping"):(a.value=[...a.value,i],console.log("[Chat] ✅ Message added from Socket.IO:",{messageId:i.id,roomId:i.room_id,totalCount:a.value.length}));const E=o.value.find(T=>T.id===i.room_id);if(E&&(E.unread_count=(E.unread_count||0)+1,typeof window<"u")){const{updateUnreadCount:T}=we();T(o.value)}}),h("user_typing",i=>{l.value.has(i.roomId)||l.value.set(i.roomId,new Set),l.value.get(i.roomId).add(i.userId)}),h("stop_typing",i=>{l.value.get(i.roomId)?.delete(i.userId)}),h("messages_read",i=>{a.value.filter(E=>E.room_id===i.roomId);const v=a.value.map(E=>E.room_id===i.roomId&&E.sender_id!==i.userId&&!E.is_read?{...E,is_read:!0}:E);if(a.value=v,i.userId===t.value?.id){const E=o.value.find(T=>T.id===i.roomId);if(E&&(E.unread_count=0,typeof window<"u")){const{updateUnreadCount:T}=we();T(o.value)}}}),h("room_joined",i=>{console.log(`[Chat] ✅ Room ${i.roomId} joined successfully - ready to receive messages`),n.value?.id===i.roomId&&(console.log("[Chat] 📋 Active room matches joined room, loading messages..."),O(i.roomId,50,0).catch(v=>{console.error("[Chat] ❌ Error loading messages after joining room:",v)}))}),h("room_left",i=>{console.log(`[Chat] 📤 Left room ${i.roomId} - will no longer receive messages from this room`)}),h("error",i=>{console.error("[Chat] ❌ Socket.IO error:",i.message)})};return{connected:le(u),socket:c,rooms:le(o),activeRoom:le(n),messages:le(a),sortedMessages:L,typingUsers:le(l),connect:y,disconnect:_,loadRooms:z,loadRoom:F,loadMessages:O,joinRoom:R,leaveRoom:B,sendMessage:Y,markAsRead:ae,startTyping:N,stopTyping:k,uploadFile:w,getRoomMessages:$,getTypingUsers:j,clearMessages:W,setActiveRoom:ne,setupChatEventListeners:A}},oo={class:"border-t p-4 bg-white relative"},no={key:0,class:"mb-3 p-3 bg-gray-50 rounded-lg border-l-4 border-l-green-600 flex items-start justify-between"},ro={class:"flex-1 min-w-0"},io={class:"text-xs text-gray-500 mb-1"},ao={class:"text-sm text-gray-700 truncate"},lo={key:1,class:"mb-3 p-3 bg-gray-50 rounded-lg flex items-center justify-between"},co={class:"flex items-center space-x-3 flex-1 min-w-0"},uo=["src"],ho={key:1,class:"w-12 h-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},fo={class:"flex-1 min-w-0"},po={class:"text-sm font-medium text-gray-900 truncate"},mo={class:"text-xs text-gray-500"},go={class:"flex items-center space-x-2"},yo=["disabled"],vo={class:"grid grid-cols-8 gap-1"},_o=["onClick"],wo=["disabled"],bo={class:"flex-1 relative"},xo=["placeholder","disabled","onKeydown"],ko=["disabled"],Co={key:0,class:"w-6 h-6 animate-spin",fill:"none",viewBox:"0 0 24 24"},$o={key:1,class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Eo={key:2,class:"mt-2 text-sm text-red-600"},To=oe({__name:"ChatInput",props:{roomId:{},placeholder:{},uploading:{type:Boolean},sending:{type:Boolean},replyingTo:{}},emits:["send-message","typing","cancel-reply"],setup(s,{emit:e}){const t=s,o=e,n=b(""),a=b(null),l=b(null),c=b(null),u=b(""),y=b(""),_=b(null),g=b(""),f=b(0),h=b(!1),C=b(null),I=["😀","😃","😄","😁","😆","😅","🤣","😂","🙂","🙃","😉","😊","😇","🥰","😍","🤩","😘","😗","😚","😙","😋","😛","😜","🤪","😝","🤑","🤗","🤭","🤫","🤔","🤐","🤨","😐","😑","😶","😏","😒","🙄","😬","🤥","😌","😔","😪","🤤","😴","😷","🤒","🤕","🤢","🤮","🤧","🥵","🥶","😶‍🌫️","😵","😵‍💫","🤯","🤠","🥳","😎","🤓","🧐","😕","😟","🙁","☹️","😮","😯","😲","😳","🥺","😦","😧","😨","😰","😥","😢","😭","😱","😖","😣","😞","😓","😩","😫","🥱","😤","😡","😠","🤬","😈","👿","💀","☠️","💩","🤡","👹","👺","👻","👽","👾","🤖","😺","😸","😹","😻","😼","😽","🙀","😿","😾","👋","🤚","🖐️","✋","🖖","👌","🤌","🤏","✌️","🤞","🤟","🤘","🤙","👈","👉","👆","🖕","👇","☝️","👍","👎","✊","👊","🤛","🤜","👏","🙌","👐","🤲","🤝","🙏","✍️","💪","🦾","🦿","🦵","🦶","👂","🦻","👃","🧠","🫀","🫁","🦷","🦴","👀","👁️","👅","👄","💋","🩸","❤️","🧡","💛","💚","💙","💜","🖤","🤍","🤎","💔","❣️","💕","💞","💓","💗","💖","💘","💝","💟","☮️","✝️","☪️","🕉️","☸️","✡️","🔯","🕎","☯️","☦️","🛐","⛎","♈","♉","♊","♋","♌","♍","♎","♏","♐","♑","♒","♓","🆔","⚛️","🉑","☢️","☣️","📴","📳","🈶","🈚","🈸","🈺","🈷️","✴️","🆚","💮","🉐","㊙️","㊗️","🈴","🈵","🈹","🈲","🅰️","🅱️","🆎","🆑","🅾️","🆘","❌","⭕","🛑","⛔","📛","🚫","💯","💢","♨️","🚷","🚯","🚳","🚱","🔞","📵","🚭","❗","❓","❕","❔","‼️","⁉️","🔅","🔆","〽️","⚠️","🚸","🔱","⚜️","🔰","♻️","✅","🈯","💹","❇️","✳️","❎","🌐","💠","Ⓜ️","🌀","💤","🏧","🚾","♿","🅿️","🈳","🈂️","🛂","🛃","🛄","🛅","🚹","🚺","🚼","🚻","🚮","🎦","📶","🈁","🔣","ℹ️","🔤","🔡","🔠","🆖","🆗","🆙","🆒","🆕","🆓","0️⃣","1️⃣","2️⃣","3️⃣","4️⃣","5️⃣","6️⃣","7️⃣","8️⃣","9️⃣","🔟","🔢","#️⃣","*️⃣","▶️","⏸️","⏯️","⏹️","⏺️","⏭️","⏮️","⏩","⏪","⏫","⏬","◀️","🔼","🔽","➡️","⬅️","⬆️","⬇️","↗️","↘️","↙️","↖️","↕️","↔️","↪️","↩️","⤴️","⤵️","🔀","🔁","🔂","🔄","🔃","🎵","🎶","➕","➖","➗","✖️","💲","💱","™️","©️","®️","〰️","➰","➿","🔚","🔙","🔛","🔜","🔝","✔️","☑️","🔘","🔴","🟠","🟡","🟢","🔵","🟣","⚫","⚪","🟤","🔺","🔻","🔸","🔹","🔶","🔷","🔳","🔲","▪️","▫️","◾","◽","◼️","◻️","🟥","🟧","🟨","🟩","🟦","🟪","⬛","⬜","🟫","🔈","🔇","🔉","🔊","🔔","🔕","📣","📢","💬","💭","🗯️","♠️","♣️","♥️","♦️","🃏","🎴","🀄","🕐","🕑","🕒","🕓","🕔","🕕","🕖","🕗","🕘","🕙","🕚","🕛","🕜","🕝","🕞","🕟","🕠","🕡","🕢","🕣","🕤","🕥","🕦","🕧"],z=N=>{if(l.value){const k=l.value.selectionStart,w=l.value.selectionEnd,$=n.value;n.value=$.substring(0,k)+N+$.substring(w),me(()=>{l.value&&(l.value.selectionStart=l.value.selectionEnd=k+N.length,l.value.focus())})}h.value=!1},F=Z(()=>(n.value.trim().length>0||c.value!==null)&&!t.uploading&&!t.sending),O=N=>{const w=N.target.files?.[0];if(!w)return;const $=w.type.startsWith("image/")?5*1024*1024:10*1024*1024;if(w.size>$){y.value=`ไฟล์ขนาดเกิน ${$/(1024*1024)}MB`;return}c.value=w,w.type.startsWith("image/")&&(u.value=URL.createObjectURL(w)),y.value=""},R=()=>{u.value&&URL.revokeObjectURL(u.value),c.value=null,u.value="",a.value&&(a.value.value="")},B=()=>{o("typing"),_.value&&clearTimeout(_.value),l.value&&(l.value.style.height="auto",l.value.style.height=Math.min(l.value.scrollHeight,120)+"px")},H=async()=>{await Y()},Y=async()=>{if(console.log("[ChatInput] 🎯 handleSend called:",{canSend:F.value,messageText:n.value,hasFile:!!c.value,roomId:t.roomId}),!F.value){console.log("[ChatInput] ⚠️ Cannot send (canSend is false)"),setTimeout(()=>{l.value&&l.value.focus()},0);return}const N=Date.now(),k=n.value.trim()||(c.value?c.value.name:"");if(g.value===k&&N-f.value<1e3){console.log("[ChatInput] ⚠️ Duplicate send prevented"),setTimeout(()=>{l.value&&l.value.focus()},0);return}y.value="",console.log("[ChatInput] ✅ Proceeding with send...");try{const w=c.value?c.value.type.startsWith("image/")?"image":"file":"text";let $,L,j,W;if(c.value){const{uploadFile:A}=Re(),i=await A(t.roomId,c.value,w==="image"?"image":"file");$=i.url,L=c.value.name,j=i.size,W=i.type}const ne=n.value.trim()||(c.value?c.value.name:"");console.log("[ChatInput] 📤 Emitting send-message event:",{content:ne,fileUrl:$,fileName:L,fileSize:j,fileType:W,messageType:w,roomId:t.roomId}),o("send-message",{content:ne,fileUrl:$,fileName:L,fileSize:j,fileType:W,messageType:w,replyToId:t.replyingTo?.id||null}),t.replyingTo&&o("cancel-reply"),console.log("[ChatInput] ✅ send-message event emitted"),g.value=ne,f.value=Date.now(),n.value="",R(),l.value&&(l.value.style.height="auto"),setTimeout(()=>{l.value&&(l.value.focus(),console.log("[ChatInput] ✅ Focused back to textarea"))},0)}catch(w){y.value=w.message||"เกิดข้อผิดพลาดในการส่งข้อความ",console.error("[ChatInput] Error sending message:",w),setTimeout(()=>{l.value&&(l.value.focus(),console.log("[ChatInput] ✅ Focused back to textarea (error case)"))},0)}},ae=N=>{if(N===0)return"0 Bytes";const k=1024,w=["Bytes","KB","MB","GB"],$=Math.floor(Math.log(N)/Math.log(k));return Math.round(N/Math.pow(k,$)*100)/100+" "+w[$]};return We(()=>{const N=k=>{const w=k.target;h.value&&C.value&&!C.value.contains(w)&&(h.value=!1)};document.addEventListener("click",N),ve(()=>{document.removeEventListener("click",N)})}),ve(()=>{u.value&&URL.revokeObjectURL(u.value),_.value&&clearTimeout(_.value)}),(N,k)=>(p(),m("div",oo,[s.replyingTo?(p(),m("div",no,[r("div",ro,[r("div",io," ตอบกลับ "+x(s.replyingTo.sender?.first_name)+" "+x(s.replyingTo.sender?.last_name),1),r("div",ao,x(s.replyingTo.content||s.replyingTo.file_name||"ไฟล์"),1)]),r("button",{onClick:k[0]||(k[0]=w=>N.$emit("cancel-reply")),class:"ml-2 text-gray-500 hover:text-gray-700 flex-shrink-0"},[...k[7]||(k[7]=[r("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])):M("",!0),d(c)?(p(),m("div",lo,[r("div",co,[d(c).type.startsWith("image/")?(p(),m("img",{key:0,src:d(u),alt:"Preview",class:"w-16 h-16 object-cover rounded"},null,8,uo)):(p(),m("svg",ho,[...k[8]||(k[8]=[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},null,-1)])])),r("div",fo,[r("p",po,x(d(c).name),1),r("p",mo,x(ae(d(c).size)),1)])]),r("button",{onClick:R,class:"ml-2 text-red-600 hover:text-red-700"},[...k[9]||(k[9]=[r("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])):M("",!0),r("div",go,[r("div",{class:"relative",ref_key:"emojiPickerContainer",ref:C},[r("button",{onClick:k[1]||(k[1]=V(w=>h.value=!d(h),["stop"])),class:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors self-center",disabled:s.uploading||s.sending,title:"เพิ่ม emoji"},[...k[10]||(k[10]=[r("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)])],8,yo),he(_t,{name:"fade"},{default:wt(()=>[d(h)?(p(),m("div",{key:0,class:"absolute bottom-full mb-2 left-0 bg-white border border-gray-200 rounded-lg shadow-xl p-3 w-64 h-64 overflow-y-auto z-[100]",onClick:k[2]||(k[2]=V(()=>{},["stop"]))},[r("div",vo,[(p(),m(ie,null,ce(I,w=>r("button",{key:w,onClick:$=>z(w),class:"p-2 hover:bg-gray-100 rounded text-lg transition-colors",type:"button"},x(w),9,_o)),64))])])):M("",!0)]),_:1})],512),r("button",{onClick:k[3]||(k[3]=w=>d(a)?.click()),class:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors self-center",disabled:s.uploading||s.sending,title:"แนบไฟล์"},[...k[11]||(k[11]=[r("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"})],-1)])],8,wo),r("input",{ref_key:"fileInput",ref:a,type:"file",class:"hidden",accept:"image/*,application/pdf,.doc,.docx,.xls,.xls,.txt",onChange:O},null,544),r("div",bo,[Be(r("textarea",{ref_key:"textarea",ref:l,"onUpdate:modelValue":k[4]||(k[4]=w=>Me(n)?n.value=w:null),placeholder:s.placeholder,disabled:s.uploading||s.sending,onKeydown:[De(V(H,["exact","prevent"]),["enter"]),k[5]||(k[5]=De(V(w=>n.value+=`
`,["shift","exact","prevent"]),["enter"]))],onInput:B,class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-none",rows:"1",style:{"max-height":"120px","min-height":"40px"}},null,40,xo),[[Ae,d(n)]])]),r("button",{onClick:Y,onMousedown:k[6]||(k[6]=V(()=>{},["prevent"])),disabled:!d(F)||s.uploading||s.sending,class:"h-[44px] w-[44px] flex items-center justify-center bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0"},[s.sending?(p(),m("svg",Co,[...k[12]||(k[12]=[r("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),r("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(p(),m("svg",$o,[...k[13]||(k[13]=[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"},null,-1)])]))],40,ko)]),d(y)?(p(),m("p",Eo,x(d(y)),1)):M("",!0)]))}}),So=Object.assign(bt(To,[["__scopeId","data-v-c9b7ef97"]]),{__name:"ChatInput"}),Ro={class:"h-full flex flex-col bg-white overflow-hidden"},Bo={key:0,class:"border-b p-4 bg-gray-50 flex-shrink-0"},Ao={class:"flex items-center space-x-3"},Mo={class:"w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden"},Oo=["src","alt"],Io={key:1,class:"text-gray-500 font-semibold"},Lo={class:"flex-1 min-w-0"},No={class:"font-semibold text-gray-900"},Po={class:"text-sm text-gray-500 truncate"},jo={key:0,class:"text-center py-2 text-sm text-gray-500"},Do={key:1,class:"text-center py-2"},Uo={key:0,class:"flex items-center justify-center my-4"},qo={class:"bg-gray-300 text-white px-4 py-1.5 rounded-lg text-sm font-medium flex items-center space-x-1"},zo=["id"],Fo={key:2,class:"flex items-center space-x-2 text-gray-500 text-sm italic py-2"},Vo={key:3,class:"text-center py-8 text-gray-500"},Ho={class:"flex-shrink-0"},Wo=["src"],Ko=oe({__name:"ChatWindow",props:{room:{},messages:{},loading:{type:Boolean,default:!1}},emits:["send-message","load-more","reply","pin"],setup(s,{emit:e}){const t=s,o=e,{user:n}=G(),{getTypingUsers:a,startTyping:l,stopTyping:c}=Re(),u=b(null),y=b(null),_=b(!1),g=b(!1),f=b(!1),h=b(!0),C=b(null),I=b(null),z=b({}),F=Z(()=>n.value?.id||0),O=Z(()=>!t.room||!n.value?null:t.room.student_id===n.value.id?t.room.tutor:t.room.student),R=Z(()=>t.room?a(t.room.id):[]),B=A=>{const i=Ce(A,"d",{locale:ye}),v=Ce(A,"MMM",{locale:ye}),E=Ce(A,"EEE",{locale:ye});return`${i} ${v} (${E}.)`},H=(A,i)=>{try{const v=typeof A=="string"?Le(A):A,E=typeof i=="string"?Le(i):i;return $t(v,E)}catch{return!1}},Y=Z(()=>{const A=[];for(let i=0;i<t.messages.length;i++){const v=t.messages[i],E=Le(v.created_at),T=i>0?t.messages[i-1]:null;(!T||!H(v.created_at,T.created_at))&&A.push({type:"date",dateLabel:B(E),key:`date-${v.id}`}),A.push({type:"message",message:v,key:`message-${v.id}-${v.created_at}`})}return A}),ae=async A=>{g.value=!0;try{o("send-message",A),await me(),ne()}finally{g.value=!1}},N=()=>{t.room&&(l(t.room.id),C.value&&clearTimeout(C.value),C.value=setTimeout(()=>{t.room&&c(t.room.id)},3e3))},k=A=>{y.value=A},w=A=>{I.value=A,me(()=>{const i=document.querySelector('textarea[placeholder="พิมพ์ข้อความ..."]');i&&i.focus()})},$=async(A,i)=>{console.log("[ChatWindow] Pin message:",A,i),o("pin",A,i)},L=A=>{const i=z.value[A]||document.getElementById(`message-${A}`);i&&u.value&&(i.scrollIntoView({behavior:"smooth",block:"center"}),i.classList.add("bg-yellow-100","transition-colors","duration-300"),setTimeout(()=>{i.classList.remove("bg-yellow-100")},2e3))},j=()=>{if(!u.value)return;const{scrollTop:A}=u.value;A<100&&h.value&&!f.value&&W()},W=()=>{o("load-more")},ne=()=>{u.value&&(u.value.scrollTop=u.value.scrollHeight)};return te(()=>t.messages.length,()=>{me(()=>{ne()})}),te(()=>t.room?.id,()=>{me(()=>{ne()})}),ve(()=>{C.value&&clearTimeout(C.value)}),(A,i)=>(p(),m("div",Ro,[s.room?(p(),m("div",Bo,[r("div",Ao,[r("div",Mo,[d(O)?.avatar_url?(p(),m("img",{key:0,src:d(O).avatar_url,alt:d(O).first_name,class:"w-full h-full object-cover"},null,8,Oo)):(p(),m("span",Io,x(d(O)?.first_name?.charAt(0)),1))]),r("div",Lo,[r("h3",No,x(d(O)?.first_name)+" "+x(d(O)?.last_name),1),r("p",Po,x(s.room.course?.title),1)])])])):M("",!0),r("div",{ref_key:"messagesContainer",ref:u,class:"flex-1 overflow-y-auto p-4 space-y-1",onScroll:j},[d(f)?(p(),m("div",jo," กำลังโหลด... ")):M("",!0),d(h)&&!d(f)?(p(),m("div",Do,[r("button",{onClick:W,class:"text-sm text-green-600 hover:text-green-700 font-medium"}," โหลดข้อความเก่า ")])):M("",!0),(p(!0),m(ie,null,ce(d(Y),(v,E)=>(p(),m(ie,{key:v.key},[v.type==="date"?(p(),m("div",Uo,[r("div",qo,[r("span",null,x(v.dateLabel),1),i[3]||(i[3]=r("svg",{class:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20"},[r("path",{"fill-rule":"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1))])])):(p(),m("div",{key:1,id:`message-${v.message.id}`,ref_for:!0,ref:T=>{T&&v.message&&(d(z)[v.message.id]=T)}},[he(ls,{message:v.message,"current-user-id":d(F),onImageClick:k,onReply:w,onPin:$,onScrollToMessage:L},null,8,["message","current-user-id"])],8,zo))],64))),128)),d(R).length>0?(p(),m("div",Fo,[...i[4]||(i[4]=[r("div",{class:"flex space-x-1"},[r("div",{class:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{"animation-delay":"0ms"}}),r("div",{class:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{"animation-delay":"150ms"}}),r("div",{class:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{"animation-delay":"300ms"}})],-1),r("span",null,"กำลังพิมพ์...",-1)])])):M("",!0),!s.loading&&s.messages.length===0?(p(),m("div",Vo," ยังไม่มีข้อความ ")):M("",!0)],544),r("div",Ho,[s.room?(p(),ke(So,{key:0,"room-id":s.room.id,placeholder:"พิมพ์ข้อความ...",uploading:d(_),sending:d(g),"replying-to":d(I),onSendMessage:ae,onTyping:N,onCancelReply:i[0]||(i[0]=v=>I.value=null)},null,8,["room-id","uploading","sending","replying-to"])):M("",!0)]),d(y)?(p(),m("div",{key:1,class:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",onClick:i[2]||(i[2]=v=>y.value=null)},[r("img",{src:d(y),alt:"Preview",class:"max-w-full max-h-full object-contain",onClick:i[1]||(i[1]=V(()=>{},["stop"]))},null,8,Wo)])):M("",!0)]))}}),Yo=Object.assign(Ko,{__name:"ChatWindow"}),Jo={class:"bg-white rounded-lg p-6 w-full max-w-md"},Xo={class:"flex items-center justify-between mb-4"},Qo={class:"space-y-4"},Go=["onKeydown"],Zo={class:"flex flex-wrap gap-2"},en=["onClick"],tn={class:"flex justify-end space-x-3"},sn=["disabled"],on=oe({__name:"AddTagModal",props:{show:{type:Boolean},roomId:{}},emits:["close","tag-added"],setup(s,{emit:e}){const t=s,o=e,n=ue(),{accessToken:a}=G(),l=b(""),c=b("#3B82F6"),u=b(!1),y=[{value:"#3B82F6",name:"Blue"},{value:"#10B981",name:"Green"},{value:"#F59E0B",name:"Orange"},{value:"#EF4444",name:"Red"},{value:"#8B5CF6",name:"Purple"},{value:"#EC4899",name:"Pink"},{value:"#06B6D4",name:"Cyan"},{value:"#84CC16",name:"Lime"}],_=async()=>{if(!(!l.value.trim()||u.value)){u.value=!0;try{(await $fetch(`${n.public.apiBase}/chat/rooms/${t.roomId}/tags`,{method:"POST",headers:{Authorization:`Bearer ${a.value}`},body:{tag_name:l.value.trim(),color:c.value}})).success&&(l.value="",c.value="#3B82F6",o("tag-added"),o("close"))}catch(g){console.error("[AddTagModal] Error adding tag:",g),alert(g.data?.message||"ไม่สามารถเพิ่มแท็กได้")}finally{u.value=!1}}};return te(()=>t.show,g=>{g||(l.value="",c.value="#3B82F6")}),(g,f)=>s.show?(p(),m("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:f[3]||(f[3]=V(h=>g.$emit("close"),["self"]))},[r("div",Jo,[r("div",Xo,[f[5]||(f[5]=r("h3",{class:"text-lg font-semibold"},"เพิ่มแท็ก",-1)),r("button",{onClick:f[0]||(f[0]=h=>g.$emit("close")),class:"text-gray-500 hover:text-gray-700"},[...f[4]||(f[4]=[r("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),r("div",Qo,[r("div",null,[f[6]||(f[6]=r("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"ชื่อแท็ก",-1)),Be(r("input",{"onUpdate:modelValue":f[1]||(f[1]=h=>Me(l)?l.value=h:null),type:"text",placeholder:"เช่น VIP, สำคัญ, ติดตาม",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",onKeydown:De(V(_,["prevent"]),["enter"])},null,40,Go),[[Ae,d(l)]])]),r("div",null,[f[7]||(f[7]=r("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"สี",-1)),r("div",Zo,[(p(),m(ie,null,ce(y,h=>r("button",{key:h.value,onClick:C=>c.value=h.value,class:X(["w-10 h-10 rounded-full border-2 transition-all",d(c)===h.value?"border-gray-800 scale-110":"border-gray-300"]),style:rt({backgroundColor:h.value})},null,14,en)),64))])]),r("div",tn,[r("button",{onClick:f[2]||(f[2]=h=>g.$emit("close")),class:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"}," ยกเลิก "),r("button",{onClick:_,disabled:!d(l).trim()||d(u),class:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},x(d(u)?"กำลังเพิ่ม...":"เพิ่ม"),9,sn)])])])])):M("",!0)}}),nn=Object.assign(on,{__name:"ChatAddTagModal"}),rn={class:"bg-white rounded-lg p-6 w-full max-w-2xl"},an={class:"flex items-center justify-between mb-4"},ln={class:"space-y-4"},cn={class:"flex justify-end space-x-3"},un=["disabled"],dn=oe({__name:"AddNoteModal",props:{show:{type:Boolean},roomId:{}},emits:["close","note-added"],setup(s,{emit:e}){const t=s,o=e,n=ue(),{accessToken:a}=G(),l=b(""),c=b(!1),u=async()=>{if(!(!l.value.trim()||c.value)){c.value=!0;try{(await $fetch(`${n.public.apiBase}/chat/rooms/${t.roomId}/notes`,{method:"POST",headers:{Authorization:`Bearer ${a.value}`},body:{content:l.value.trim()}})).success&&(l.value="",o("note-added"),o("close"))}catch(y){console.error("[AddNoteModal] Error adding note:",y),alert(y.data?.message||"ไม่สามารถเพิ่มโน้ตได้")}finally{c.value=!1}}};return te(()=>t.show,y=>{y||(l.value="")}),(y,_)=>s.show?(p(),m("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:_[3]||(_[3]=V(g=>y.$emit("close"),["self"]))},[r("div",rn,[r("div",an,[_[5]||(_[5]=r("h3",{class:"text-lg font-semibold"},"เพิ่มโน้ต",-1)),r("button",{onClick:_[0]||(_[0]=g=>y.$emit("close")),class:"text-gray-500 hover:text-gray-700"},[..._[4]||(_[4]=[r("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),r("div",ln,[r("div",null,[_[6]||(_[6]=r("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"เนื้อหาโน้ต",-1)),Be(r("textarea",{"onUpdate:modelValue":_[1]||(_[1]=g=>Me(l)?l.value=g:null),rows:"6",placeholder:"บันทึกข้อมูลผู้ใช้ บันทึกบทสนทนา หรือเพิ่มข้อความสำหรับส่งต่องาน...",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"},null,512),[[Ae,d(l)]]),_[7]||(_[7]=r("p",{class:"text-xs text-gray-500 mt-1"},"ผู้ใช้จะไม่เห็นเนื้อหาในโน้ตนี้",-1))]),r("div",cn,[r("button",{onClick:_[2]||(_[2]=g=>y.$emit("close")),class:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"}," ยกเลิก "),r("button",{onClick:u,disabled:!d(l).trim()||d(c),class:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},x(d(c)?"กำลังเพิ่ม...":"เพิ่ม"),9,un)])])])])):M("",!0)}}),hn=Object.assign(dn,{__name:"ChatAddNoteModal"}),fn={class:"bg-white rounded-lg p-6 w-full max-w-2xl"},pn={class:"flex items-center justify-between mb-4"},mn={class:"space-y-4"},gn={class:"flex justify-end space-x-3"},yn=["disabled"],vn=oe({__name:"EditNoteModal",props:{note:{}},emits:["close","note-updated"],setup(s,{emit:e}){const t=s,o=e,n=ue(),{accessToken:a}=G(),l=b(""),c=b(!1);te(()=>t.note,y=>{y&&(l.value=y.content)},{immediate:!0});const u=async()=>{if(!(!t.note||!l.value.trim()||c.value)){c.value=!0;try{(await $fetch(`${n.public.apiBase}/chat/rooms/${t.note.room_id}/notes/${t.note.id}`,{method:"PUT",headers:{Authorization:`Bearer ${a.value}`},body:{content:l.value.trim()}})).success&&(o("note-updated"),o("close"))}catch(y){console.error("[EditNoteModal] Error updating note:",y),alert(y.data?.message||"ไม่สามารถแก้ไขโน้ตได้")}finally{c.value=!1}}};return(y,_)=>s.note?(p(),m("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:_[3]||(_[3]=V(g=>y.$emit("close"),["self"]))},[r("div",fn,[r("div",pn,[_[5]||(_[5]=r("h3",{class:"text-lg font-semibold"},"แก้ไขโน้ต",-1)),r("button",{onClick:_[0]||(_[0]=g=>y.$emit("close")),class:"text-gray-500 hover:text-gray-700"},[..._[4]||(_[4]=[r("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),r("div",mn,[r("div",null,[_[6]||(_[6]=r("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"เนื้อหาโน้ต",-1)),Be(r("textarea",{"onUpdate:modelValue":_[1]||(_[1]=g=>Me(l)?l.value=g:null),rows:"6",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"},null,512),[[Ae,d(l)]])]),r("div",gn,[r("button",{onClick:_[2]||(_[2]=g=>y.$emit("close")),class:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"}," ยกเลิก "),r("button",{onClick:u,disabled:!d(l).trim()||d(c),class:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},x(d(c)?"กำลังบันทึก...":"บันทึก"),9,yn)])])])])):M("",!0)}}),_n=Object.assign(vn,{__name:"ChatEditNoteModal"}),wn={class:"w-80 border-l bg-white flex-shrink-0 overflow-y-auto flex flex-col h-full"},bn={key:0,class:"flex-1 flex items-center justify-center p-4"},xn={key:1,class:"flex-1 overflow-y-auto"},kn={class:"p-4 border-b"},Cn={class:"flex flex-col items-center mb-4"},$n={class:"w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden mb-3"},En=["src","alt"],Tn={key:1,class:"text-gray-500 text-2xl font-semibold"},Sn={class:"text-lg font-semibold text-gray-900 mb-1"},Rn={class:"p-4 border-b"},Bn={class:"flex items-center justify-between mb-3"},An={key:0,class:"text-sm text-gray-500 text-center py-4"},Mn={key:1,class:"flex flex-wrap gap-2"},On={class:"p-4 border-b"},In={class:"flex items-center justify-between mb-3"},Ln={class:"text-sm font-semibold text-gray-700"},Nn={class:"text-gray-500 font-normal"},Pn={key:0,class:"text-sm text-gray-500 text-center py-4"},jn={key:1,class:"space-y-3"},Dn={class:"text-sm text-gray-900 whitespace-pre-wrap"},Un={class:"flex items-center justify-between mt-2 text-xs text-gray-500"},qn={key:0},zn=["onClick"],Fn=oe({__name:"ChatRoomSidebar",props:{room:{}},setup(s){const e=s,{user:t}=G(),o=ue(),{accessToken:n}=G(),a=b([]),l=b([]),c=b(!1),u=b(!1),y=b(!1),_=b(null),g=Z(()=>!e.room||!t.value?null:e.room.student_id===t.value.id?e.room.tutor:e.room.student);te(()=>e.room?.id,async O=>{O?(await f(),await h()):(a.value=[],l.value=[])},{immediate:!0});const f=async()=>{if(e.room?.id)try{const O=await $fetch(`${o.public.apiBase}/chat/rooms/${e.room.id}/tags`,{headers:{Authorization:`Bearer ${n.value}`}});O.success&&(a.value=O.data)}catch(O){console.error("[ChatRoomSidebar] Error loading tags:",O)}},h=async()=>{if(e.room?.id)try{const O=await $fetch(`${o.public.apiBase}/chat/rooms/${e.room.id}/notes`,{headers:{Authorization:`Bearer ${n.value}`}});O.success&&(l.value=O.data)}catch(O){console.error("[ChatRoomSidebar] Error loading notes:",O)}},C=()=>{f()},I=()=>{h()},z=()=>{_.value=null,h()},F=O=>{_.value=O};return(O,R)=>(p(),m("div",wn,[s.room?(p(),m("div",xn,[r("div",kn,[r("div",Cn,[r("div",$n,[d(g)?.avatar_url?(p(),m("img",{key:0,src:d(g).avatar_url,alt:d(g).first_name,class:"w-full h-full object-cover"},null,8,En)):(p(),m("span",Tn,x(d(g)?.first_name?.charAt(0)),1))]),r("h3",Sn,x(d(g)?.first_name)+" "+x(d(g)?.last_name),1),r("button",{onClick:R[0]||(R[0]=B=>y.value=!0),class:"text-gray-500 hover:text-gray-700",title:"แก้ไขชื่อ"},[...R[7]||(R[7]=[r("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)])])])]),r("div",Rn,[r("div",Bn,[R[9]||(R[9]=r("h4",{class:"text-sm font-semibold text-gray-700"},"แท็ก",-1)),r("button",{onClick:R[1]||(R[1]=B=>c.value=!0),class:"flex items-center space-x-1 px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors"},[...R[8]||(R[8]=[r("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),r("span",null,"ใส่แท็ก",-1)])])]),d(a).length===0?(p(),m("div",An," ยังไม่มีแท็ก ")):(p(),m("div",Mn,[(p(!0),m(ie,null,ce(d(a),B=>(p(),m("span",{key:B.id,style:rt({backgroundColor:B.color+"20",color:B.color,borderColor:B.color}),class:"px-3 py-1 rounded-full text-sm font-medium border"},x(B.tag_name),5))),128))]))]),r("div",On,[r("div",In,[r("h4",Ln,[R[10]||(R[10]=Ge(" โน้ต ",-1)),r("span",Nn,"("+x(d(l).length)+")",1)]),r("button",{onClick:R[2]||(R[2]=B=>u.value=!0),class:"flex items-center space-x-1 px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors"},[...R[11]||(R[11]=[r("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),r("span",null,"เพิ่มโน้ต",-1)])])]),d(l).length===0?(p(),m("div",Pn," ยังไม่มีโน้ต ")):(p(),m("div",jn,[(p(!0),m(ie,null,ce(d(l),B=>(p(),m("div",{key:B.id,class:"bg-gray-50 rounded-lg p-3"},[r("p",Dn,x(B.content),1),r("div",Un,[r("span",null,[Ge(" สร้างโดย "+x(B.creator?.first_name)+" "+x(B.creator?.last_name)+" ",1),B.updated_by&&B.updated_by!==B.created_by?(p(),m("span",qn," (แก้ไขล่าสุดโดย "+x(B.updater?.first_name)+" "+x(B.updater?.last_name)+") ",1)):M("",!0)]),r("button",{onClick:H=>F(B),class:"text-green-600 hover:text-green-700"}," แก้ไข ",8,zn)])]))),128))]))])])):(p(),m("div",bn,[...R[6]||(R[6]=[r("div",{class:"text-center text-gray-500"},[r("svg",{class:"w-16 h-16 mx-auto mb-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})]),r("p",{class:"text-sm"},"เลือกห้องแชทเพื่อดูข้อมูล")],-1)])])),s.room?(p(),ke(nn,{key:2,show:d(c),"room-id":s.room.id,onClose:R[3]||(R[3]=B=>c.value=!1),onTagAdded:C},null,8,["show","room-id"])):M("",!0),s.room?(p(),ke(hn,{key:3,show:d(u),"room-id":s.room.id,onClose:R[4]||(R[4]=B=>u.value=!1),onNoteAdded:I},null,8,["show","room-id"])):M("",!0),d(_)?(p(),ke(_n,{key:4,note:d(_),onClose:R[5]||(R[5]=B=>_.value=null),onNoteUpdated:z},null,8,["note"])):M("",!0)]))}}),Vn=Object.assign(Fn,{__name:"ChatRoomSidebar"}),Hn={class:"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col"},Wn={class:"px-6 py-4 border-b flex items-center justify-between"},Kn={class:"flex-1 overflow-y-auto p-6"},Yn={key:0,class:"text-center py-8"},Jn={key:1,class:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"},Xn={key:2,class:"text-center py-8 text-gray-500"},Qn={key:3,class:"space-y-3"},Gn={class:"flex items-start space-x-4"},Zn={class:"w-20 h-20 bg-gray-200 rounded-lg flex-shrink-0 overflow-hidden"},er=["src","alt"],tr={key:1,class:"w-full h-full flex items-center justify-center text-gray-400"},sr={class:"flex-1 min-w-0"},or={class:"font-semibold text-gray-900 mb-1"},nr={class:"text-sm text-gray-600 mb-2"},rr={class:"flex items-center justify-between"},ir={key:0,class:"text-xs text-green-600 font-medium"},ar={key:1,class:"text-xs text-gray-500"},lr=["onClick","disabled"],cr=oe({__name:"CreateChatRoomModal",props:{show:{type:Boolean}},emits:["close","room-created"],setup(s,{emit:e}){const t=s,o=e,n=ue(),{accessToken:a}=G(),l=b([]),c=b(!1),u=b(""),y=b(!1),_=async()=>{c.value=!0,u.value="";try{const f=await $fetch(`${n.public.apiBase}/learning/available-chats`,{headers:{Authorization:`Bearer ${a.value}`}});f.success&&(l.value=f.data)}catch(f){console.error("[CreateChatRoomModal] Error loading options:",f),u.value=f.data?.message||"ไม่สามารถโหลดข้อมูลได้"}finally{c.value=!1}},g=async f=>{if(f.chatRoomId){o("room-created",f.chatRoomId),o("close");return}y.value=!0;try{const h=await $fetch(`${n.public.apiBase}/chat/rooms`,{method:"POST",headers:{Authorization:`Bearer ${a.value}`},body:{course_id:f.course.id,tutor_id:f.tutor.id}});h.success&&(o("room-created",h.data.id),o("close"))}catch(h){console.error("[CreateChatRoomModal] Error creating room:",h),u.value=h.data?.message||"ไม่สามารถสร้างห้องแชทได้"}finally{y.value=!1}};return te(()=>t.show,f=>{f&&_()}),(f,h)=>s.show?(p(),m("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:h[1]||(h[1]=V(C=>f.$emit("close"),["self"]))},[r("div",Hn,[r("div",Wn,[h[3]||(h[3]=r("h2",{class:"text-xl font-semibold"},"เริ่มแชทกับอาจารย์",-1)),r("button",{onClick:h[0]||(h[0]=C=>f.$emit("close")),class:"text-gray-400 hover:text-gray-600"},[...h[2]||(h[2]=[r("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),r("div",Kn,[d(c)?(p(),m("div",Yn,[...h[4]||(h[4]=[r("div",{class:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"},null,-1),r("p",{class:"mt-2 text-gray-600"},"กำลังโหลด...",-1)])])):d(u)?(p(),m("div",Jn,x(d(u)),1)):d(l).length===0?(p(),m("div",Xn,[...h[5]||(h[5]=[r("svg",{class:"mx-auto h-12 w-12 text-gray-400 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1),r("p",null,"คุณยังไม่มีคอร์สที่สามารถแชทได้",-1),r("p",{class:"text-sm mt-2"},"กรุณาลงทะเบียนเรียนคอร์สก่อน",-1)])])):(p(),m("div",Qn,[(p(!0),m(ie,null,ce(d(l),C=>(p(),m("div",{key:`${C.course.id}-${C.tutor.id}-${C.studentId}`,class:X(["border rounded-lg p-4 hover:bg-gray-50 transition-colors",C.chatRoomId?"border-green-200 bg-green-50":"border-gray-200"])},[r("div",Gn,[r("div",Zn,[C.course.thumbnail?(p(),m("img",{key:0,src:C.course.thumbnail,alt:C.course.title,class:"w-full h-full object-cover"},null,8,er)):(p(),m("div",tr,[...h[6]||(h[6]=[r("svg",{class:"w-8 h-8",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})],-1)])]))]),r("div",sr,[r("h3",or,x(C.course.title),1),r("p",nr," อาจารย์: "+x(C.tutor.firstName)+" "+x(C.tutor.lastName),1),r("div",rr,[C.chatRoomId?(p(),m("span",ir," ✓ มีห้องแชทอยู่แล้ว ")):(p(),m("span",ar," ยังไม่มีห้องแชท ")),r("button",{onClick:I=>g(C),disabled:d(y),class:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium"},x(C.chatRoomId?"เปิดแชท":"เริ่มแชท"),9,lr)])])])],2))),128))]))])])])):M("",!0)}}),ur=Object.assign(cr,{__name:"ChatCreateChatRoomModal"}),dr={class:"h-full flex overflow-hidden"},hr={class:"w-80 border-r bg-white flex-shrink-0 overflow-y-auto"},fr={class:"flex-1 flex flex-col min-w-0 overflow-hidden"},pr={key:0,class:"flex-1 flex items-center justify-center bg-gray-50"},mr={key:1,class:"flex-1 flex min-w-0 overflow-hidden"},Cr=oe({__name:"index",setup(s){G();const{rooms:e,activeRoom:t,setActiveRoom:o,loadRooms:n,loadMessages:a,sendMessage:l,markAsRead:c,sortedMessages:u,setupChatEventListeners:y,connect:_,connected:g,socket:f}=Re(),h=b(!1),C=b(!1),I=b(0),z=b(!0),F=b(!1);b(!1);const O=Z(()=>[...e.value]);We(async()=>{h.value=!0;try{if(console.log("[Chat Page] 🚀 Mounting chat page, setting up Socket.IO..."),g.value)console.log("[Chat Page] ✅ Socket.IO already connected");else{console.log("[Chat Page] 🔌 Connecting Socket.IO..."),_();let j=0;for(;!g.value&&j<20;)await new Promise(W=>setTimeout(W,100)),j++;g.value||console.warn("[Chat Page] ⚠️ Socket.IO connection timeout")}console.log("[Chat Page] 👂 Setting up event listeners...");let w=0;for(;!f.value&&w<20;)await new Promise(j=>setTimeout(j,100)),w++;f.value?(console.log("[Chat Page] ✅ Socket available, setting up event listeners, socket ID:",f.value.id),y()):(console.warn("[Chat Page] ⚠️ Socket not available after waiting, will retry in setupChatEventListeners"),y()),console.log("[Chat Page] 📋 Loading rooms..."),await n();const $=Ze(),L=$.query.roomId?parseInt($.query.roomId):null;if(L){const j=e.value.find(W=>W.id===L);j&&(console.log("[Chat Page] 🔄 Restoring active room from URL:",L),await H(j),c(L))}else e.value.length>0&&t.value&&(console.log("[Chat Page] 📋 Marking active room as read on page entry:",t.value.id),c(t.value.id));console.log("[Chat Page] ✅ Chat page setup complete")}catch(w){console.error("[Chat Page] ❌ Error loading rooms:",w)}finally{h.value=!1}}),ve(()=>{const{disconnect:w}=Re();w()}),te(()=>t.value?.id,async w=>{w?(await B(w),c(w)):(I.value=0,z.value=!0)},{immediate:!0});const R=u;te(()=>R.value.length,(w,$)=>{console.log("[Chat] 📏 Message count changed:",{oldLength:$,newLength:w,willScroll:w>($||0)})});const B=async(w,$=!1)=>{C.value=!0;try{const L=$?I.value:0,j=await a(w,50,L);if(!j){console.error("[Chat] loadMessages returned undefined");return}j.length<50?z.value=!1:(I.value+=j.length,z.value=!0)}catch(L){console.error("[Chat] Error loading messages:",L)}finally{C.value=!1}},H=async w=>{console.log("[Chat] 🎯 Selecting room:",w.id),o(w),I.value=0,z.value=!0;const $=Ze(),L=xt();$.query.roomId!==w.id.toString()&&await L.replace({query:{...$.query,roomId:w.id.toString()}})},Y=b(!1),ae=async w=>{if(console.log("[Chat Page] 🎯 handleSendMessage called:",{hasActiveRoom:!!t.value,roomId:t.value?.id,content:w.content?.substring(0,50),messageType:w.messageType,isSending:Y.value}),!t.value){console.error("[Chat Page] ❌ No active room");return}if(Y.value){console.log("[Chat Page] ⚠️ Already sending a message, skipping duplicate");return}Y.value=!0,console.log("[Chat Page] ✅ Sending state set to true");try{console.log("[Chat Page] 📤 Calling sendMessage composable..."),await l({room_id:t.value.id,content:w.content,message_type:w.messageType,file_url:w.fileUrl,file_name:w.fileName,file_size:w.fileSize,file_type:w.fileType,reply_to_id:w.replyToId||null}),console.log("[Chat Page] ✅ sendMessage completed successfully"),c(t.value.id)}catch($){console.error("[Chat Page] ❌ Error in handleSendMessage:",{error:$.message,stack:$.stack,response:$.response})}finally{setTimeout(()=>{Y.value=!1,console.log("[Chat Page] 🔄 Sending state reset to false")},500)}},N=async()=>{!t.value||!z.value||C.value||await B(t.value.id,!0)},k=async w=>{await n();const $=e.value.find(L=>L.id===w);$&&await H($)};return(w,$)=>(p(),m("div",dr,[r("div",hr,[he(Ht,{rooms:d(O),"active-room":d(t),loading:d(h),onSelectRoom:H,onCreateRoom:$[0]||($[0]=L=>F.value=!0)},null,8,["rooms","active-room","loading"])]),r("div",fr,[d(t)?(p(),m("div",mr,[he(Yo,{class:"flex-1 min-w-0",room:d(t),messages:d(R),loading:d(C),onSendMessage:ae,onLoadMore:N},null,8,["room","messages","loading"]),he(Vn,{class:"flex-shrink-0",room:d(t)},null,8,["room"])])):(p(),m("div",pr,[...$[2]||($[2]=[r("div",{class:"text-center text-gray-500"},[r("svg",{class:"w-16 h-16 mx-auto mb-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})]),r("p",{class:"text-lg"},"เลือกห้องแชทเพื่อเริ่มการสนทนา")],-1)])]))]),he(ur,{show:d(F),onClose:$[1]||($[1]=L=>F.value=!1),onRoomCreated:k},null,8,["show"])]))}});export{Cr as default};

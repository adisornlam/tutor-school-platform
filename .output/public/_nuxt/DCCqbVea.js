import{d as I,m as O,p as j,l as R,B as T,r as d,q as F,o as J,c as r,b as t,e as n,F as w,v as k,t as i,x as c,g as v,J as $,i as S,K as q,f as K,y as L,s as P,j as G,a}from"./B_rLn4hw.js";import{A as H}from"./DTlFZqZS.js";const Q={class:"flex items-center justify-between mb-6"},W={class:"flex items-center space-x-4"},X={key:0,class:"text-center py-12"},Y={key:0,class:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6"},Z={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},ee=["disabled"],te={value:""},se=["value"],ne=["disabled"],oe={value:""},le=["value"],re={class:"md:col-span-2"},ae={class:"flex gap-6"},de={class:"flex items-center cursor-pointer"},ie={class:"flex items-center cursor-pointer"},ue={key:0},ce=["required","disabled"],pe={value:""},me=["value"],ge={key:1},be={key:0,class:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded"},ye={class:"flex justify-end space-x-3 pt-4 border-t"},ve=["disabled"],_e={key:0},fe={key:1},ke=I({__name:"edit",setup(he){const A=O(),E=j(),g=G(),{accessToken:b}=R(),y=T(()=>parseInt(A.params.id)),_=d(!0),u=d(""),p=d(!1),m=d(""),s=F({student_id:0,course_id:0,branch_id:0,enrollment_type:"onsite",shipping_address_id:null,enrollment_date:"",status:"pending"}),V=d([]),C=d([]),B=d([]),f=d(!1),h=d(!1),x=d(!1),M=async()=>{f.value=!0;try{const o=await $fetch(`${g.public.apiBase}/admin/users`,{headers:{Authorization:`Bearer ${b.value}`},params:{role:"student"}});o.success&&(V.value=o.data)}catch(o){console.error("Error loading students:",o)}finally{f.value=!1}},N=async()=>{h.value=!0;try{const o=await $fetch(`${g.public.apiBase}/admin/courses`,{headers:{Authorization:`Bearer ${b.value}`},params:{status:"published"}});o.success&&(C.value=o.data)}catch(o){console.error("Error loading courses:",o)}finally{h.value=!1}},U=async()=>{if(!s.course_id){B.value=[],s.branch_id=0;return}x.value=!0;try{const o=await $fetch(`${g.public.apiBase}/admin/courses/${s.course_id}`,{headers:{Authorization:`Bearer ${b.value}`}});o.success&&o.data.branches&&(B.value=o.data.branches.map(e=>({id:e.branch_id,name:e.branch_name,code:e.branch_code})))}catch(o){console.error("Error loading branches:",o),u.value="ไม่สามารถโหลดข้อมูลสาขาได้"}finally{x.value=!1}},z=async()=>{if(!y.value||isNaN(y.value)){u.value="รหัสการลงทะเบียนไม่ถูกต้อง",_.value=!1;return}_.value=!0,u.value="";try{const o=await $fetch(`${g.public.apiBase}/admin/enrollments/${y.value}`,{headers:{Authorization:`Bearer ${b.value}`}});if(o.success&&o.data.enrollment){const e=o.data.enrollment;s.student_id=e.student_id,s.course_id=e.course_id,s.branch_id=e.branch_id||0,s.enrollment_type=e.enrollment_type||"onsite",s.shipping_address_id=e.shipping_address_id||null,s.status=e.status,s.enrollment_date=e.enrollment_date?new Date(e.enrollment_date).toISOString().slice(0,16):new Date(e.created_at).toISOString().slice(0,16),await U()}else u.value="ไม่พบข้อมูลการลงทะเบียน"}catch(o){console.error("Error loading enrollment:",o),u.value=o.data?.message||o.message||"เกิดข้อผิดพลาดในการโหลดข้อมูล"}finally{_.value=!1}},D=async()=>{p.value=!0,m.value="";try{if(s.enrollment_type==="onsite"&&!s.branch_id){m.value="กรุณาเลือกสาขาสำหรับเรียนสด",p.value=!1;return}if(s.enrollment_type==="online"&&!s.shipping_address_id){m.value="กรุณาเลือกที่อยู่จัดส่งสำหรับเรียนออนไลน์",p.value=!1;return}const o={student_id:s.student_id,course_id:s.course_id,enrollment_type:s.enrollment_type,status:s.status,enrollment_date:s.enrollment_date||new Date().toISOString()};s.enrollment_type==="onsite"?o.branch_id=s.branch_id:o.shipping_address_id=s.shipping_address_id,await $fetch(`${g.public.apiBase}/admin/enrollments/${y.value}`,{method:"PUT",headers:{Authorization:`Bearer ${b.value}`},body:o}),await E.push(`/admin/enrollments/${y.value}`)}catch(o){console.error("Error updating enrollment:",o),m.value=o.data?.message||"เกิดข้อผิดพลาดในการบันทึกข้อมูล"}finally{p.value=!1}};return J(()=>{M(),N(),z()}),(o,e)=>(a(),r("div",null,[t("div",Q,[t("div",W,[t("button",{onClick:e[0]||(e[0]=l=>o.$router.back()),class:"p-2 hover:bg-gray-100 rounded-lg"},[...e[10]||(e[10]=[t("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})],-1)])]),e[11]||(e[11]=t("h1",{class:"text-3xl font-bold"},"แก้ไขการลงทะเบียน",-1))])]),n(_)?(a(),r("div",X,[...e[12]||(e[12]=[t("div",{class:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"},null,-1),t("p",{class:"mt-4 text-gray-600"},"กำลังโหลดข้อมูล...",-1)])])):(a(),r(w,{key:1},[n(u)?(a(),r("div",Y,i(n(u)),1)):k("",!0),t("form",{onSubmit:P(D,["prevent"]),class:"bg-white rounded-lg shadow p-6 space-y-6"},[t("div",Z,[t("div",null,[e[13]||(e[13]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[v(" นักเรียน "),t("span",{class:"text-red-500"},"*")],-1)),c(t("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>n(s).student_id=l),required:"",disabled:n(f),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 disabled:bg-gray-100 disabled:cursor-not-allowed"},[t("option",te,i(n(f)?"กำลังโหลด...":"เลือกนักเรียน"),1),(a(!0),r(w,null,S(n(V),l=>(a(),r("option",{key:l.id,value:l.id},i(l.first_name)+" "+i(l.last_name)+" (@"+i(l.username)+") ",9,se))),128))],8,ee),[[$,n(s).student_id]])]),t("div",null,[e[14]||(e[14]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[v(" คอร์ส "),t("span",{class:"text-red-500"},"*")],-1)),c(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>n(s).course_id=l),required:"",disabled:n(h),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 disabled:bg-gray-100 disabled:cursor-not-allowed",onChange:U},[t("option",oe,i(n(h)?"กำลังโหลด...":"เลือกคอร์ส"),1),(a(!0),r(w,null,S(n(C),l=>(a(),r("option",{key:l.id,value:l.id},i(l.title),9,le))),128))],40,ne),[[$,n(s).course_id]])]),t("div",re,[e[17]||(e[17]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[v(" ประเภทการเรียน "),t("span",{class:"text-red-500"},"*")],-1)),t("div",ae,[t("label",de,[c(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>n(s).enrollment_type=l),type:"radio",value:"onsite",class:"mr-2 w-4 h-4 text-green-600 focus:ring-green-500"},null,512),[[q,n(s).enrollment_type]]),e[15]||(e[15]=t("span",{class:"text-gray-700"},"เรียนสด (Onsite)",-1))]),t("label",ie,[c(t("input",{"onUpdate:modelValue":e[4]||(e[4]=l=>n(s).enrollment_type=l),type:"radio",value:"online",class:"mr-2 w-4 h-4 text-green-600 focus:ring-green-500"},null,512),[[q,n(s).enrollment_type]]),e[16]||(e[16]=t("span",{class:"text-gray-700"},"เรียนออนไลน์ (Online)",-1))])])]),n(s).enrollment_type==="onsite"?(a(),r("div",ue,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[v(" สาขา "),t("span",{class:"text-red-500"},"*")],-1)),c(t("select",{"onUpdate:modelValue":e[5]||(e[5]=l=>n(s).branch_id=l),required:n(s).enrollment_type==="onsite",disabled:!n(s).course_id||n(x),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 disabled:bg-gray-100 disabled:cursor-not-allowed bg-white text-gray-900"},[t("option",pe,i(n(x)?"กำลังโหลด...":"เลือกสาขา"),1),(a(!0),r(w,null,S(n(B),l=>(a(),r("option",{key:l.id,value:l.id},i(l.name),9,me))),128))],8,ce),[[$,n(s).branch_id]])])):k("",!0),n(s).enrollment_type==="online"&&n(s).student_id?(a(),r("div",ge,[K(H,{modelValue:n(s).shipping_address_id,"onUpdate:modelValue":e[6]||(e[6]=l=>n(s).shipping_address_id=l),"user-id":n(s).student_id,required:n(s).enrollment_type==="online",placeholder:"เลือกที่อยู่จัดส่ง",hint:"สำหรับส่งเอกสารประกอบการเรียน"},null,8,["modelValue","user-id","required"])])):k("",!0),t("div",null,[e[20]||(e[20]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[v(" สถานะ "),t("span",{class:"text-red-500"},"*")],-1)),c(t("select",{"onUpdate:modelValue":e[7]||(e[7]=l=>n(s).status=l),required:"",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"},[...e[19]||(e[19]=[t("option",{value:"pending"},"รอการยืนยัน",-1),t("option",{value:"active"},"กำลังเรียน",-1),t("option",{value:"completed"},"เรียนจบ",-1),t("option",{value:"cancelled"},"ยกเลิก",-1)])],512),[[$,n(s).status]])]),t("div",null,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," วันที่ลงทะเบียน ",-1)),c(t("input",{"onUpdate:modelValue":e[8]||(e[8]=l=>n(s).enrollment_date=l),type:"datetime-local",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white text-gray-900",style:{"color-scheme":"light"}},null,512),[[L,n(s).enrollment_date]])])]),n(m)?(a(),r("div",be,i(n(m)),1)):k("",!0),t("div",ye,[t("button",{type:"button",onClick:e[9]||(e[9]=l=>o.$router.back()),class:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100"}," ยกเลิก "),t("button",{type:"submit",disabled:n(p),class:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"},[n(p)?(a(),r("span",_e,"กำลังบันทึก...")):(a(),r("span",fe,"บันทึก"))],8,ve)])],32)],64))]))}});export{ke as default};

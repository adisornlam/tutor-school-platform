# สรุปการวิเคราะห์ระบบ: แพลตฟอร์มโรงเรียนกวดวิชาหลายสาขา

## 🎯 ภาพรวมโปรเจกต์

### วัตถุประสงค์
สร้างแพลตฟอร์มการศึกษาแบบ Full-stack สำหรับโรงเรียนกวดวิชาที่มีหลายสาขา โดยรองรับการจัดการนักเรียน หลักสูตร อาจารย์ การชำระเงิน และการเรียนรู้แบบออนไลน์

### เทคโนโลยีหลัก
- **Nuxt.js 4**: Frontend + Backend ในโปรเจกต์เดียว
- **MySQL 8**: ฐานข้อมูลหลัก
- **JWT + Refresh Token**: ระบบ Authentication
- **Server-Sent Events (SSE)**: การแจ้งเตือนแบบ Real-time

---

## 🏛️ สถาปัตยกรรมระบบ

### โครงสร้างหลัก
```
┌─────────────────────────────────────┐
│      Nuxt.js 4 Application          │
│  ┌──────────┐  ┌──────────┐        │
│  │ Frontend │  │   API    │        │
│  │  (Vue)   │  │ (Nitro)  │        │
│  └──────────┘  └──────────┘        │
│         │            │              │
│  ┌──────────────────────────┐      │
│  │  SSE Notifications       │      │
│  └──────────────────────────┘      │
└──────────────────┬──────────────────┘
                   │
            ┌──────▼──────┐
            │   MySQL 8   │
            └─────────────┘
```

---

## 👥 บทบาทผู้ใช้ (User Roles)

1. **Student (นักเรียน)**
   - ลงทะเบียนเรียน
   - ชำระเงิน
   - เข้าถึงเนื้อหาการเรียนรู้
   - ดูประวัติการเรียน

2. **Tutor (อาจารย์)**
   - จัดการโปรไฟล์
   - ดูตารางสอน
   - เข้าถึงรายชื่อนักเรียน

3. **Branch Admin (ผู้ดูแลสาขา)**
   - จัดการสาขาของตัวเอง
   - อนุมัติการลงทะเบียน
   - จัดการโปรโมชั่นสาขา
   - ดูรายงานสาขา

4. **System Admin (ผู้ดูแลระบบ)**
   - จัดการทุกสาขา
   - จัดการผู้ใช้ทั้งหมด
   - ดูรายงานระบบ

5. **Owner (เจ้าของ)**
   - เข้าถึงทุกอย่าง
   - ดู Dashboard ภาพรวม
   - วิเคราะห์รายได้ทุกสาขา

---

## 📊 โมดูลหลักของระบบ

### 1. ระบบผู้ใช้และการยืนยันตัวตน
- ลงทะเบียน/เข้าสู่ระบบ
- JWT + Refresh Token
- จัดการโปรไฟล์
- ระบบสิทธิ์แบบ Role-based

**ตารางหลัก**: `users`, `roles`, `user_roles`, `refresh_tokens`

### 2. ระบบจัดการสาขา
- สร้าง/แก้ไข/ปิดสาขา
- กำหนดผู้ดูแลสาขา
- ดูสถิติสาขา

**ตารางหลัก**: `branches`, `branch_admins`

### 3. ระบบจัดการอาจารย์ ⭐
**ความสำคัญ**: อาจารย์ต้องเชื่อมโยงกับสาขาและหลักสูตร

- อาจารย์ 1 คน → สอนได้หลายสาขา
- อาจารย์ 1 คน → สอนได้หลายหลักสูตร
- แต่ละสาขามีตารางสอนต่างกัน

**ตารางหลัก**: 
- `tutors` (ข้อมูลอาจารย์)
- `tutor_branches` (อาจารย์ ↔ สาขา)
- `tutor_courses` (อาจารย์ ↔ หลักสูตร ↔ สาขา)

### 4. ระบบหลักสูตร
**ประเภทหลักสูตร**:
- Live Online Class (เรียนสดออนไลน์)
- Video on Demand - VOD (เรียนวิดีโอ)
- Hybrid (ผสมผสาน)

**ฟีเจอร์**:
- สร้าง/แก้ไข/ลบหลักสูตร
- กำหนดสาขาที่เปิดสอน
- กำหนดอาจารย์ผู้สอน
- กำหนดจำนวนที่นั่ง
- จัดตารางเรียน

**ตารางหลัก**: `courses`, `course_branches`, `course_schedules`

### 5. ระบบโปรโมชั่นและราคา 🆕
**ประเภทโปรโมชั่น**:
- ส่วนลดเปอร์เซ็นต์ (%)
- ส่วนลดราคาคงที่ (บาท)
- Early-bird (ลงทะเบียนล่วงหน้า)
- โปรโมชั่นเฉพาะสาขา
- โปรโมชั่นจำกัดเวลา

**กฎการใช้งาน**:
- โปรโมชั่นสามารถเป็น: Global, ต่อสาขา, ต่อหลักสูตร
- มีวันเริ่มต้น/สิ้นสุด
- มีจำนวนการใช้งานจำกัด (ถ้าต้องการ)
- สามารถใช้ร่วมกันได้หรือไม่ (Stackable)

**ตารางหลัก**: 
- `promotions` (ข้อมูลโปรโมชั่น)
- `promotion_courses` (โปรโมชั่น ↔ หลักสูตร)
- `promotion_branches` (โปรโมชั่น ↔ สาขา)
- `promotion_usage` (ประวัติการใช้งาน)

### 6. ระบบลงทะเบียนและสิทธิ์การเรียนรู้
- นักเรียนลงทะเบียนหลักสูตร
- ได้รับสิทธิ์การเรียนรู้
- สิทธิ์กำหนด: เข้าเรียนสดได้, ดู VOD ได้, วันหมดอายุ

**ตารางหลัก**: `enrollments`, `learning_rights`

### 7. ระบบชำระเงิน
- สร้างการชำระเงิน
- ติดตามสถานะการชำระ
- อ้างอิงใบแจ้งหนี้/ใบเสร็จ
- ใช้โปรโมชั่นตอนชำระเงิน

**ตารางหลัก**: `payments`, `payment_items`

### 8. ระบบการเรียนรู้
- ตรวจสอบสิทธิ์เข้าเรียนสด
- ตรวจสอบสิทธิ์ดู VOD
- ติดตามความคืบหน้า
- สถานะการเรียนจบ

**ตารางหลัก**: `learning_progress`, `course_sessions`

### 9. ระบบแจ้งเตือน (SSE) 🔔
**ใช้ Server-Sent Events สำหรับ Real-time**

**ประเภทการแจ้งเตือน**:
- แจ้งเตือนก่อนเรียน (24 ชม.)
- แจ้งเตือนชำระเงินสำเร็จ
- แจ้งเตือนโปรโมชั่นใหม่
- ประกาศจาก Admin
- แจ้งเตือนลงทะเบียนสำเร็จ

**ตารางหลัก**: `notifications`, `notification_reads`

### 10. Dashboard สำหรับ Admin และ Owner
**Admin (สาขา/ระบบ)**:
- จัดการผู้ใช้
- อนุมัติหลักสูตร
- จัดการโปรโมชั่น
- ดูภาพรวมการลงทะเบียน
- รายงานการชำระเงิน

**Owner**:
- Dashboard KPI ภาพรวม
- รายได้แยกตามสาขา
- รายได้แยกตามหลักสูตร
- ภาพรวมประสิทธิภาพอาจารย์

---

## 🔗 ความสัมพันธ์ข้อมูลสำคัญ

### อาจารย์ ↔ สาขา ↔ หลักสูตร
```
อาจารย์ A ──┐
           ├──> สอนที่สาขา 1 ──> หลักสูตร X, Y
           └──> สอนที่สาขา 2 ──> หลักสูตร Z
```

### โปรโมชั่น
```
โปรโมชั่น Global ──> ใช้ได้ทุกสาขา, ทุกหลักสูตร
โปรโมชั่นสาขา ──> ใช้ได้เฉพาะสาขา A
โปรโมชั่นหลักสูตร ──> ใช้ได้เฉพาะหลักสูตร X
```

### การลงทะเบียน
```
นักเรียน ──> ลงทะเบียนหลักสูตร X ที่สาขา A ──> ชำระเงิน ──> ได้สิทธิ์การเรียนรู้
```

---

## 🎨 โครงสร้างโปรเจกต์

```
Tutor-School-Platform/
├── components/          # Vue Components
├── pages/              # หน้าเว็บ (Auto-routing)
├── layouts/            # Layout templates
├── middleware/         # Route middleware (auth, role)
├── composables/        # Vue composables (useAuth, useSSE)
├── server/
│   ├── api/           # API endpoints
│   ├── services/      # Business logic
│   └── utils/         # Utilities (db, jwt, validation)
└── types/             # TypeScript types
```

---

## 🔐 ระบบความปลอดภัย

### Authentication
- **Access Token**: หมดอายุ 15 นาที
- **Refresh Token**: หมดอายุ 7 วัน (เก็บในฐานข้อมูล)
- **Token Rotation**: สร้าง Refresh Token ใหม่ทุกครั้งที่ refresh

### ระบบสิทธิ์ (RBAC)
- ใช้ Permission-based (ไม่ใช่ Role-based แบบ hard-code)
- แต่ละ Role มี Permission ต่างกัน
- Scope: own (ของตัวเอง), branch (สาขา), all (ทั้งหมด)

---

## ⚡ จุดสำคัญที่ต้องระวัง

### 1. การลงทะเบียนพร้อมกัน
- **ปัญหา**: หลายคนลงทะเบียนพร้อมกัน อาจเกินจำนวนที่นั่ง
- **วิธีแก้**: ใช้ Database Transaction + Row Locking

### 2. การจัดการ SSE Connection
- **ปัญหา**: หลายแท็บ, การตัดการเชื่อมต่อ
- **วิธีแก้**: Connection pooling, Heartbeat mechanism

### 3. ความปลอดภัย Webhook
- **ปัญหา**: ต้องยืนยันว่า Webhook มาจาก Payment Gateway จริง
- **วิธีแก้**: ใช้ HMAC signature validation

### 4. กฎโปรโมชั่นที่ซับซ้อน
- **ปัญหา**: โปรโมชั่นที่ใช้ร่วมกันได้, จำกัดจำนวนครั้ง
- **วิธีแก้**: Service layer พร้อม Rule Engine

### 5. การแยกข้อมูลสาขา
- **ปัญหา**: Branch Admin ต้องเห็นแค่ข้อมูลสาขาของตัวเอง
- **วิธีแก้**: Middleware กรองข้อมูลตามสาขา

---

## 📅 แผนการพัฒนา

### Phase 1: พื้นฐาน (สัปดาห์ 1-2)
- ✅ Setup โปรเจกต์
- ✅ สร้าง Database Schema
- ✅ ระบบ Authentication
- ✅ ระบบ RBAC พื้นฐาน

### Phase 2: โมดูลหลัก (สัปดาห์ 3-4)
- ✅ จัดการสาขา
- ✅ จัดการอาจารย์
- ✅ จัดการหลักสูตร
- ✅ ระบบลงทะเบียน

### Phase 3: ตรรกะธุรกิจ (สัปดาห์ 5-6)
- ✅ ระบบโปรโมชั่น
- ✅ ระบบชำระเงิน
- ✅ สิทธิ์การเรียนรู้
- ✅ ติดตามความคืบหน้า

### Phase 4: Real-time & Admin (สัปดาห์ 7-8)
- ✅ ระบบแจ้งเตือน SSE
- ✅ Admin Dashboard
- ✅ รายงานและวิเคราะห์
- ✅ Owner Dashboard

### Phase 5: ปรับปรุงและทดสอบ (สัปดาห์ 9-10)
- ✅ จัดการ Error
- ✅ Validation
- ✅ Security Audit
- ✅ เพิ่มประสิทธิภาพ
- ✅ เอกสาร

---

## ✅ สิ่งที่ต้องทำก่อนเริ่มพัฒนา

1. **ตรวจสอบการวิเคราะห์** - ยืนยันการตัดสินใจด้านสถาปัตยกรรม
2. **ปรับแต่ง Database Schema** - ปรับตามความต้องการเฉพาะ
3. **กำหนด API Endpoints** - เพิ่ม/ลบ endpoints ตามต้องการ
4. **เริ่มพัฒนา** - เริ่มจาก Phase 1

---

## 📌 หมายเหตุสำคัญ

- ใช้ UTC สำหรับ Timestamp ทั้งหมด
- สกุลเงินเริ่มต้น: THB (บาทไทย)
- รูปแบบวันที่: ISO 8601
- API Response: JSON
- Error Response: รูปแบบที่สอดคล้องกัน
- Logging: Structured logging สำหรับ debugging

---

*เอกสารนี้สรุปจาก PROJECT_ANALYSIS.md สำหรับความเข้าใจที่ง่ายขึ้น*

